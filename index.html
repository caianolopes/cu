<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ConferÃªncia de NFe - Responsivo</title>
Â  Â  <!-- Favicon -->
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">
Â  Â  <!-- Libraries -->
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-color: #007bff;
Â  Â  Â  Â  Â  Â  --secondary-color: #6c757d;
Â  Â  Â  Â  Â  Â  --bg-color: #f8f9fa;
Â  Â  Â  Â  Â  Â  --text-color: #333;
Â  Â  Â  Â  Â  Â  --border-color: #dee2e6;
Â  Â  Â  Â  Â  Â  --hover-color: #f1f1f1;
Â  Â  Â  Â  Â  Â  --success-color: #28a745;
Â  Â  Â  Â  Â  Â  --danger-color: #dc3545;
Â  Â  Â  Â  Â  Â  --danger-light-color: #f8d7da;
Â  Â  Â  Â  Â  Â  --danger-text-color: #721c24;
Â  Â  Â  Â  Â  Â  --warning-light-color: #fff3cd;
Â  Â  Â  Â  Â  Â  --warning-text-color: #856404;
Â  Â  Â  Â  Â  Â  --white-color: #fff;
Â  Â  Â  Â  Â  Â  --shadow: 0 4px 6px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  --highlight-color: #cce5ff;
Â  Â  Â  Â  }

Â  Â  Â  Â  body, html {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  overflow: hidden; /* Evita a rolagem do corpo da pÃ¡gina */
Â  Â  Â  Â  }

Â  Â  Â  Â  .view-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Coluna da Esquerda (Painel Lateral) --- */
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  width: 380px;
Â  Â  Â  Â  Â  Â  background-color: var(--white-color);
Â  Â  Â  Â  Â  Â  border-right: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-in-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar-header {
Â  Â  Â  Â  Â  Â  padding: 1rem 1.5rem;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar-header h1 {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  Â  Â  color: var(--primary-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .settings-container {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  #settings-btn, #accounting-settings-btn {
Â  Â  Â  Â  Â  Â  background: none; border: none; cursor: pointer;
Â  Â  Â  Â  Â  Â  padding: 0.5rem; color: var(--secondary-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #settings-btn:hover, #accounting-settings-btn:hover {
Â  Â  Â  Â  Â  Â  color: var(--primary-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .dropdown-content {
Â  Â  Â  Â  Â  Â  position: absolute; right: 0; top: calc(100% + 5px);
Â  Â  Â  Â  Â  Â  background-color: var(--white-color); min-width: 220px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 16px rgba(0,0,0,0.15); z-index: 10;
Â  Â  Â  Â  Â  Â  border-radius: 8px; border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding: 0.5rem 0; overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .dropdown-item {
Â  Â  Â  Â  Â  Â  width: 100%; text-align: left; border: none;
Â  Â  Â  Â  Â  Â  background-color: transparent; cursor: pointer;
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1.5rem; display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dropdown-item:hover { background-color: var(--hover-color); }

Â  Â  Â  Â  .controls-section {
Â  Â  Â  Â  Â  Â  padding: 1rem; display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr; gap: 0.5rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  padding: 0.75rem; border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  background-color: var(--white-color); cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem; transition: all 0.2s ease;
Â  Â  Â  Â  Â  Â  text-align: center; display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center; justify-content: center; gap: 0.5rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn:hover {
Â  Â  Â  Â  Â  Â  border-color: var(--primary-color); color: var(--primary-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .btn:disabled {
Â  Â  Â  Â  Â  Â  background-color: #e9ecef; border-color: var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--secondary-color); cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background-color: var(--primary-color); color: var(--white-color);
Â  Â  Â  Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:hover {
Â  Â  Â  Â  Â  Â  background-color: #0056b3; border-color: #0056b3; color: var(--white-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-danger {
Â  Â  Â  Â  Â  Â  color: var(--danger-color); border-color: var(--danger-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-danger:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--danger-color); color: var(--white-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .btn-success {
Â  Â  Â  Â  Â  Â  background-color: var(--success-color); color: var(--white-color);
Â  Â  Â  Â  Â  Â  border-color: var(--success-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-success:hover {
Â  Â  Â  Â  Â  Â  background-color: #218838; border-color: #1e7e34;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

Â  Â  Â  Â  .list-search-controls {
Â  Â  Â  Â  Â  Â  padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .search-input {
Â  Â  Â  Â  Â  Â  width: 100%; padding: 0.5rem; border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color); font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  .list-controls {
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1.5rem; border-top: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color); background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .list-controls > div { display: flex; align-items: center; gap: 0.5rem; }
Â  Â  Â  Â  
Â  Â  Â  Â  .xml-list-container { flex-grow: 1; overflow-y: auto; }
Â  Â  Â  Â  .xml-list { list-style: none; padding: 0; margin: 0; }
Â  Â  Â  Â  .xml-list li {
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s ease; font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .xml-list-item-content { flex-grow: 1; cursor: pointer; padding: 0.25rem 0; }
Â  Â  Â  Â  .xml-list li:hover { background-color: var(--hover-color); }
Â  Â  Â  Â  .xml-list li.selected { background-color: var(--primary-color); color: white; }
Â  Â  Â  Â  .xml-list li.selected strong, .xml-list li.selected span { color: white !important; }
Â  Â  Â  Â  
Â  Â  Â  Â  .sidebar-footer {
Â  Â  Â  Â  Â  Â  padding: 1rem; font-size: 0.8rem; color: var(--secondary-color);
Â  Â  Â  Â  Â  Â  border-top: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  #auto-import-path { font-style: italic; word-break: break-all; }

Â  Â  Â  Â  /* --- Coluna da Direita (ConteÃºdo Principal) --- */
Â  Â  Â  Â  .content-area {
Â  Â  Â  Â  Â  Â  flex-grow: 1; padding: 1.5rem; overflow-y: auto;
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .content-header-mobile {
Â  Â  Â  Â  Â  Â  display: none; /* Oculto por padrÃ£o */
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .welcome-message {
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center; height: 100%; text-align: center;
Â  Â  Â  Â  Â  Â  color: var(--secondary-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .welcome-message .icon { font-size: 4rem; margin-bottom: 1rem; }
Â  Â  Â  Â  .xml-content { display: none; }

Â  Â  Â  Â  .nfe-header {
Â  Â  Â  Â  Â  Â  position: relative; background-color: var(--white-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px; border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow);
Â  Â  Â  Â  }

Â  Â  Â  Â  #view-all-photos-btn { position: absolute; top: 1.5rem; right: 1.5rem; }

Â  Â  Â  Â  .items-section {
Â  Â  Â  Â  Â  Â  flex-grow: 1; display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  background-color: var(--white-color); border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color); padding: 1.5rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 1.5rem; box-shadow: var(--shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .items-section-header {
Â  Â  Â  Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  Â  Â  Â  gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .items-section-header h3 { margin: 0; }
Â  Â  Â  Â  .filter-input {
Â  Â  Â  Â  Â  Â  padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  font-size: 0.9rem; flex-grow: 1; min-width: 150px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .items-section-header .btn-group { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
Â  Â  Â  Â  .items-table-container { overflow-y: auto; flex-grow: 1; }

Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; }
Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  padding: 0.75rem; text-align: left;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  font-size: 0.9rem; vertical-align: middle;
Â  Â  Â  Â  }
Â  Â  Â  Â  th { background-color: var(--bg-color); }
Â  Â  Â  Â  tr.item-highlight {
Â  Â  Â  Â  Â  Â  background-color: var(--highlight-color) !important;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .quantity-input {
Â  Â  Â  Â  Â  Â  width: 70px; padding: 5px; border-radius: 5px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .quantity-input:disabled { background-color: #e9ecef; cursor: not-allowed; }

Â  Â  Â  Â  .photo-cell { width: 140px; }
Â  Â  Â  Â  .unit-cell { width: 60px; text-align: center; }

Â  Â  Â  Â  .thumbnail-container {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; gap: 5px; cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .thumbnail-img {
Â  Â  Â  Â  Â  Â  width: 40px; height: 40px; border-radius: 4px;
Â  Â  Â  Â  Â  Â  object-fit: cover; border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .thumbnail-counter {
Â  Â  Â  Â  Â  Â  width: 40px; height: 40px; border-radius: 4px; background-color: var(--hover-color);
Â  Â  Â  Â  Â  Â  color: var(--secondary-color); display: flex; align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center; font-weight: bold; font-size: 0.9em;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Modais --- */
Â  Â  Â  Â  .modal {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; z-index: 1000; left: 0; top: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
Â  Â  Â  Â  Â  Â  align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background-color: var(--white-color); padding: 20px; border-radius: 8px;
Â  Â  Â  Â  Â  Â  width: 90%; max-width: 500px;
Â  Â  Â  Â  Â  Â  max-height: 90vh; display: flex; flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-header {
Â  Â  Â  Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .close-button { font-size: 1.5rem; font-weight: bold; cursor: pointer; }

Â  Â  Â  Â  .modal-body {
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding-right: 10px; /* Evita que a scrollbar sobreponha o conteÃºdo */
Â  Â  Â  Â  }

Â  Â  Â  Â  #photo-gallery {
Â  Â  Â  Â  Â  Â  overflow-y: auto; padding: 5px; display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .gallery-item { position: relative; }
Â  Â  Â  Â  .gallery-item img {
Â  Â  Â  Â  Â  Â  width: 100%; height: 100px; object-fit: cover; border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer; display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â  .delete-photo-btn {
Â  Â  Â  Â  Â  Â  position: absolute; top: 5px; right: 5px; background-color: rgba(220, 53, 69, 0.8);
Â  Â  Â  Â  Â  Â  color: white; border: none; border-radius: 50%; width: 24px; height: 24px;
Â  Â  Â  Â  Â  Â  cursor: pointer; font-size: 14px; display: flex; align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center; line-height: 1; transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .delete-photo-btn:hover { background-color: var(--danger-color); }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Lightbox */
Â  Â  Â  Â  #lightbox {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; z-index: 1002; left: 0; top: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85);
Â  Â  Â  Â  Â  Â  flex-direction: column; align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #lightbox-img { max-width: 90vw; max-height: 80vh; object-fit: contain; }
Â  Â  Â  Â  .lightbox-nav {
Â  Â  Â  Â  Â  Â  cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%);
Â  Â  Â  Â  Â  Â  color: white; font-size: 2.5rem; padding: 1rem; user-select: none;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .lightbox-nav:hover { background-color: rgba(255, 255, 255, 0.1); }
Â  Â  Â  Â  #lightbox-prev { left: 10px; }
Â  Â  Â  Â  #lightbox-next { right: 10px; }
Â  Â  Â  Â  #lightbox-close { top: 15px; right: 20px; font-size: 2.5rem; }
Â  Â  Â  Â  #lightbox-delete { top: 20px; left: 20px; background: none; border: none; color: white; font-size: 1.8rem;}

Â  Â  Â  Â  /* Wizard Modal (Slide-in Panel) */
Â  Â  Â  Â  #wizard-modal {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; z-index: 1001; left: 0; top: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  justify-content: flex-end; align-items: stretch;
Â  Â  Â  Â  }
Â  Â  Â  Â  #wizard-content {
Â  Â  Â  Â  Â  Â  width: 35%; max-width: 500px; height: 100%; background-color: var(--white-color);
Â  Â  Â  Â  Â  Â  box-shadow: -5px 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  animation: slideIn 0.3s forwards;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

Â  Â  Â  Â  #wizard-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
Â  Â  Â  Â  #wizard-body { padding: 1.5rem; overflow-y: auto; flex-shrink: 0; }
Â  Â  Â  Â  #wizard-photo-viewer {
Â  Â  Â  Â  Â  Â  flex-grow: 1; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  padding: 1rem; position: relative; background-color: #e9ecef;
Â  Â  Â  Â  Â  Â  border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  min-height: 150px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #wizard-photo-strip {
Â  Â  Â  Â  Â  Â  display: flex; gap: 10px; height: 100%; width: 100%;
Â  Â  Â  Â  Â  Â  align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #wizard-photo-strip img {
Â  Â  Â  Â  Â  Â  width: 50%; height: 100%; object-fit: contain; border-radius: 4px;
Â  Â  Â  Â  Â  Â  background-color: var(--white-color); cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .wizard-photo-nav {
Â  Â  Â  Â  Â  Â  position: absolute; top: 50%; transform: translateY(-50%);
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 5;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .wizard-photo-nav:hover { background-color: rgba(0,0,0,0.6); }
Â  Â  Â  Â  .wizard-photo-nav:disabled { opacity: 0.2; cursor: not-allowed; }
Â  Â  Â  Â  #wizard-photo-prev { left: 15px; }
Â  Â  Â  Â  #wizard-photo-next { right: 15px; }

Â  Â  Â  Â  #wizard-footer {
Â  Â  Â  Â  Â  Â  padding: 1rem 1.5rem; flex-shrink: 0; display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between; align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .wizard-item-info { margin-bottom: 1rem; }
Â  Â  Â  Â  .wizard-item-info strong {
Â  Â  Â  Â  Â  Â  display: block; color: var(--primary-color); margin-bottom: 0.25rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Item Registration View */
Â  Â  Â  Â  .form-group {
Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-control {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  #item-reg-photo-preview {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  Â  Â  margin-top: 1rem;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  object-fit: contain;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-actions {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  #manual-check-error {
Â  Â  Â  Â  Â  Â  color: var(--danger-text-color);
Â  Â  Â  Â  Â  Â  background-color: var(--danger-light-color);
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Estilos da Galeria de Fotos no Modal Manual --- */
Â  Â  Â  Â  .photo-gallery-inline {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  min-height: 50px;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .photo-gallery-inline .gallery-item {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .photo-gallery-inline .gallery-item img {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .photo-gallery-inline .delete-photo-btn {
Â  Â  Â  Â  Â  Â  top: 2px;
Â  Â  Â  Â  Â  Â  right: 2px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* UtilitÃ¡rios */
Â  Â  Â  Â  .d-none { display: none !important; }

Â  Â  Â  Â  /* --- ESTILOS RESPONSIVOS --- */
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .view-container { flex-direction: column; }
Â  Â  Â  Â  Â  Â  .sidebar, .content-area, #item-registration-view {
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  Â  Â  border-right: none;
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .content-area, #item-registration-view {
Â  Â  Â  Â  Â  Â  Â  Â  left: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 2; /* Fica por cima do sidebar */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .view-container.content-visible .sidebar {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateX(-30%); /* Efeito de deslizar para fora */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .view-container.content-visible .content-area,
Â  Â  Â  Â  Â  Â  .view-container.content-visible #item-registration-view {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateX(-100%);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  .content-header-mobile { display: flex; }
Â  Â  Â  Â  Â  Â  .welcome-message { display: none; } /* Oculta a mensagem de boas vindas em mobile */

Â  Â  Â  Â  Â  Â  /* Tabela Responsiva para Cards */
Â  Â  Â  Â  Â  Â  table thead { display: none; }
Â  Â  Â  Â  Â  Â  table tr {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: var(--white-color);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  table td {
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0.5rem 0;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted var(--border-color);
Â  Â  Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  table td:last-child { border-bottom: none; }
Â  Â  Â  Â  Â  Â  table td::before {
Â  Â  Â  Â  Â  Â  Â  Â  content: attr(data-label);
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  margin-right: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .photo-cell { justify-content: center !important; padding-bottom: 1rem; }
Â  Â  Â  Â  Â  Â  .photo-cell::before { display: none; } /* Sem label para a foto */
Â  Â  Â  Â  Â  Â  .quantity-input { text-align: right; }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  #wizard-content { width: 95%; max-width: 95%; }
Â  Â  Â  Â  Â  Â  .items-section-header .btn-group .btn {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #manual-check-view .modal-content {
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 95%;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <!-- VISÃƒO PRINCIPAL (CONFERÃŠNCIA) -->
Â  Â  <div id="main-view" class="view-container">
Â  Â  Â  Â  <!-- Painel Lateral Esquerdo -->
Â  Â  Â  Â  <aside class="sidebar">
Â  Â  Â  Â  Â  Â  <div class="sidebar-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h1>ðŸ“¦ ConferÃªncia NFe</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="settings-btn" title="ConfiguraÃ§Ãµes">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="settings-dropdown" class="dropdown-content d-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="dropdown-item" onclick="showItemRegistrationView()">Cadastro de Itens</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="dropdown-item" onclick="showAccountingView()">Contabilidade</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="dropdown-item" onclick="backupData()">Fazer Backup</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="dropdown-item" onclick="document.getElementById('restore-file-input').click()">Restaurar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="restore-file-input" class="d-none" accept=".json">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="dropdown-item btn-danger" onclick="deleteAllData()">Apagar Tudo</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="controls-section">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="document.getElementById('xml-file-input').click()">Importar XML/TXT</button>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="xml-file-input" multiple class="d-none" accept=".xml,.nfe,.txt">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="displayMultipleXMLs()">Visualizar SeleÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="list-search-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="search-xml-input" class="search-input" placeholder="Pesquisar Notas..." onkeyup="filterXMLList('#xml-list', this.value)">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="list-controls d-none" id="main-list-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked, '#xml-list .xml-checkbox')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="select-all-checkbox">Selecionar Todos</label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="delete-selected-btn" class="btn btn-danger btn-sm d-none" onclick="deleteSelectedXMLs()">Apagar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="xml-list-container"><ul id="xml-list" class="xml-list"></ul></div>
Â  Â  Â  Â  Â  Â  <div class="sidebar-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>ImportaÃ§Ã£o AutomÃ¡tica:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="auto-import-path">A carregar...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </aside>

Â  Â  Â  Â  <!-- Ãrea de ConteÃºdo Principal -->
Â  Â  Â  Â  <main class="content-area">
Â  Â  Â  Â  Â  Â  Â <div class="content-header-mobile">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="showListView('#main-view')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Voltar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="welcome-message" class="welcome-message">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="icon">ðŸ“¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Selecione uma nota fiscal</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Escolha um ficheiro na lista Ã  esquerda para ver os seus detalhes.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="xml-content" class="xml-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="nfe-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="nfe-filename"></h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="nfe-details"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="view-all-photos-btn" class="btn d-none">Ver Todas as Fotos</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="items-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="items-section-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Itens da Nota</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filter-input" class="filter-input" placeholder="Filtrar por DescriÃ§Ã£o/CÃ³d...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="manual-check-trigger-btn" class="btn" disabled>ConferÃªncia por EAN</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="main-action-btn" class="btn"></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="sort-items-btn" class="btn">Organizar A-Z</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="items-table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="items-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th class="photo-cell">Fotos</th><th>CÃ³d.</th><th>DescriÃ§Ã£o</th><th class="unit-cell">Unid.</th><th>Qtd.</th><th>Recebido</th><th>EAN</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <!-- VISÃƒO DE CONTABILIDADE -->
Â  Â  <div id="accounting-view" class="view-container d-none">
Â  Â  Â  Â  <aside class="sidebar">
Â  Â  Â  Â  Â  Â  <div class="sidebar-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h1>ðŸ“Š Contabilidade</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn" onclick="showMainView()">Voltar Ã  ConferÃªncia</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="list-search-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="search-accounting-input" class="search-input" placeholder="Pesquisar Notas Arquivadas..." onkeyup="filterXMLList('#accounting-xml-list', this.value)">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="xml-list-container"><ul id="accounting-xml-list" class="xml-list"></ul></div>
Â  Â  Â  Â  </aside>

Â  Â  Â  Â  <main class="content-area">
Â  Â  Â  Â  Â  Â  Â <div class="content-header-mobile">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="showListView('#accounting-view')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Voltar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="accounting-welcome-message" class="welcome-message">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="icon">ðŸ“Š</div>
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Selecione uma nota arquivada</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>As notas finalizadas aparecem aqui.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="accounting-xml-content" class="xml-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="nfe-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="accounting-nfe-filename"></h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="accounting-nfe-details"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="accounting-view-all-photos-btn" class="btn d-none">Ver Todas as Fotos</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="items-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="items-section-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Itens da Nota Arquivada</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="btn-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="wizard-btn" class="btn btn-primary">Wizard</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="accounting-main-action-btn" class="btn">Reabrir Nota</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="settings-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="accounting-note-settings-btn" title="OpÃ§Ãµes da Nota" class="btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="accounting-note-dropdown" class="dropdown-content d-none" style="min-width: 250px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="delete-finished-xml-btn" class="dropdown-item" style="color: var(--danger-color);">Excluir Permanentemente</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="items-table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="accounting-items-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th class="photo-cell">Fotos</th><th>CÃ³d.</th><th>DescriÃ§Ã£o</th><th class="unit-cell">Unid.</th><th>Qtd.</th><th>Recebido</th><th>EAN</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <!-- VISÃƒO DE CADASTRO DE ITENS -->
Â  Â  <div id="item-registration-view" class="view-container d-none">
Â  Â  Â  Â  <main class="content-area">
Â  Â  Â  Â  Â  Â  <div class="content-header-mobile">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="showMainViewFromRegistration()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Voltar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="items-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Cadastro de Item</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="item-reg-cprod">CÃ³digo Interno</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="item-reg-cprod" class="form-control">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="item-reg-ean">EAN</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="item-reg-ean" class="form-control">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="item-reg-desc">DescriÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="item-reg-desc" class="form-control">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Foto do Produto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="item-reg-photo-preview" src="" alt="PrÃ©-visualizaÃ§Ã£o da foto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="item-reg-add-photo-btn" class="btn">Carregar Foto</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="item-reg-photo-input" class="d-none" accept="image/*" capture="environment">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="fetchItemDataFromXml()">Buscar de XML</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="saveItemRegistration()">Salvar Item</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <!-- Modal para galeria de fotos -->
Â  Â  <div id="photo-modal" class="modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="modal-item-name">Fotos do Item</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="close-button" onclick="closeModal()">&times;</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="photo-gallery"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="add-photo-btn" class="btn btn-primary" style="margin-top: 15px;">Adicionar/Tirar Foto</button>
Â  Â  Â  Â  Â  Â  <input type="file" id="photo-input" accept="image/*" multiple class="d-none" capture="environment">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <!-- Lightbox para visualizaÃ§Ã£o de foto expandida -->
Â  Â  <div id="lightbox">
Â  Â  Â  Â  <span id="lightbox-close" class="lightbox-nav" onclick="closeLightbox()">&times;</span>
Â  Â  Â  Â  <span id="lightbox-prev" class="lightbox-nav" onclick="navigateLightbox(-1)">&#10094;</span>
Â  Â  Â  Â  <img id="lightbox-img" src="">
Â  Â  Â  Â  <span id="lightbox-next" class="lightbox-nav" onclick="navigateLightbox(1)">&#10095;</span>
Â  Â  Â  Â  <button id="lightbox-delete" class="lightbox-nav" title="Apagar esta foto" onclick="deleteCurrentLightboxPhoto()">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <!-- Wizard Modal -->
Â  Â  <div id="wizard-modal" class="modal">Â 
Â  Â  Â  Â  <div id="wizard-content">
Â  Â  Â  Â  Â  Â  <div id="wizard-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="wizard-title">Wizard de Itens</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="close-button" onclick="closeWizard()">&times;</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="wizard-body"></div>
Â  Â  Â  Â  Â  Â  <div id="wizard-photo-viewer">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="wizard-photo-prev" class="wizard-photo-nav">&#10094;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="wizard-photo-strip"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="wizard-photo-next" class="wizard-photo-nav">&#10095;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="wizard-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="wizard-prev" class="btn">Anterior</button>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="wizard-counter">Item 1 de 10</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="wizard-next" class="btn">PrÃ³ximo</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Modal de ConferÃªncia Manual -->
Â  Â  <div id="manual-check-view" class="modal">
Â  Â  Â  Â  <div class="modal-content" style="max-width: 600px;">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ConferÃªncia Manual de Item</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="close-button" onclick="hideManualCheckView()">&times;</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="manual-check-form-container" class="modal-body">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="display: flex; gap: 1rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="manual-check-ean" class="form-control" placeholder="Cole ou digite o EAN do item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="paste-ean-btn" class="btn">Colar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="manual-check-error" class="d-none"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="manual-item-selector-container" class="form-group d-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-item-selector">O EAN nÃ£o foi encontrado. A qual item ele pertence?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="manual-item-selector" class="form-control"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="select-item-btn" class="btn btn-primary" style="margin-top: 0.5rem;">Selecionar Item</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="manual-check-details" class="d-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-check-desc">DescriÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="manual-check-desc" class="form-control" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SEÃ‡ÃƒO DE FOTOS NA CONFERÃŠNCIA MANUAL -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="manual-check-photo-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Fotos do Item</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="manual-check-photo-gallery" class="photo-gallery-inline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Miniaturas das fotos serÃ£o injetadas aqui -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="manual-check-photo-input" accept="image/*" multiple class="d-none" capture="environment">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="manual-check-add-photo-btn" class="btn btn-sm" style="margin-top: 10px;">Adicionar/Tirar Foto</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-check-qty">Quantidade (Nota)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="manual-check-qty" class="form-control" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-check-unit-factor">Fator UnitÃ¡rio</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="manual-check-unit-factor" class="form-control" value="1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-check-received-qty">Quantidade Recebida</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="manual-check-received-qty" class="form-control">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="manual-check-unit-type">Caixa ou Unidade</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="manual-check-unit-type" class="form-control" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-actions" style="justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="finish-item-btn" class="btn btn-success" disabled>Finalizar Item</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // !!! ATENÃ‡ÃƒO: SUBSTITUA 'SEU_IP_LOCAL' PELO ENDEREÃ‡O IP REAL DO SEU COMPUTADOR !!!
Â  Â  Â  Â  // Exemplo: 'http://192.168.1.100:5000'
Â  Â  Â  Â  const BASE_URL = 'http://SEU_IP_LOCAL:5000'; // NÃ£o esqueÃ§a da porta do Flask (geralmente 5000)

Â  Â  Â  Â  // ConexÃ£o Socket.IO para atualizaÃ§Ãµes em tempo real do servidor local
Â  Â  Â  Â  const socket = io(BASE_URL, { secure: false, transports: ['websocket'] });
Â  Â  Â  Â  const NFE_NAMESPACE = 'http://www.portalfiscal.inf.br/nfe';
Â  Â  Â  Â  let currentData = {};
Â  Â  Â  Â  let currentItemKeyForPhoto = null;Â 
Â  Â  Â  Â  let isItemsSorted = false;
Â  Â  Â  Â  let currentViewMode = 'single';
Â  Â  Â  Â  let currentAppView = 'main';
Â  Â  Â  Â  let itemRegPhotoBase64 = null;
Â  Â  Â  Â  let currentManualCheckCProd = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Lightbox state
Â  Â  Â  Â  let currentLightboxIndex = -1;
Â  Â  Â  Â  let lightboxSourceList = [];

Â  Â  Â  Â  // Wizard state
Â  Â  Â  Â  let wizardItems = [];
Â  Â  Â  Â  let wizardCurrentIndex = 0;
Â  Â  Â  Â  let wizardPhotoIndex = 0;
Â  Â  Â  Â  let wizardCurrentXmlId = null;

Â  Â  Â  Â  // Mobile state
Â  Â  Â  Â  const isMobile = () => window.innerWidth <= 768;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ConexÃ£o e AtualizaÃ§Ãµes com o Servidor ---
Â  Â  Â  Â  socket.on('connect', () => console.log('Ligado ao servidor com sucesso!'));
Â  Â  Â  Â  socket.on('set_auto_import_path', (data) => document.getElementById('auto-import-path').textContent = data.path);
Â  Â  Â  Â Â 
Â  Â  Â  Â  socket.on('data_updated', () => {
Â  Â  Â  Â  Â  Â  console.log('Dados atualizados pelo servidor.');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const selectedMainId = (currentAppView === 'main' && currentViewMode === 'single') ? document.querySelector('#xml-list li.selected')?.dataset.id : null;
Â  Â  Â  Â  Â  Â  const isMultiView = (currentAppView === 'main' && currentViewMode === 'multiple');
Â  Â  Â  Â  Â  Â  const selectedAccountingId = (currentAppView === 'accounting') ? document.querySelector('#accounting-xml-list li.selected')?.dataset.id : null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const photoModalIsOpen = document.getElementById('photo-modal').style.display === 'flex';
Â  Â  Â  Â  Â  Â  const lightboxIsOpen = document.getElementById('lightbox').style.display === 'flex';
Â  Â  Â  Â  Â  Â  const manualCheckIsOpen = document.getElementById('manual-check-view').style.display === 'flex';

Â  Â  Â  Â  Â  Â  const oldCProd = currentManualCheckCProd;

Â  Â  Â  Â  Â  Â  fetchData().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (manualCheckIsOpen) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderXMLList();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderAccountingXMLList();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (oldCProd) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderManualCheckPhotoGallery(oldCProd);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  renderXMLList();
Â  Â  Â  Â  Â  Â  Â  Â  renderAccountingXMLList();

Â  Â  Â  Â  Â  Â  Â  Â  if (currentAppView === 'main') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMultiView) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayMultipleXMLs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (selectedMainId && currentData.xmls.some(xml => xml.id === selectedMainId && !xml.finished)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayXMLContent(selectedMainId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentAppView === 'accounting') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectedAccountingId && currentData.xmls.some(xml => xml.id === selectedAccountingId && xml.finished)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayFinishedXMLContent(selectedAccountingId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetToAccountingWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (photoModalIsOpen && currentItemKeyForPhoto) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemNameElement = document.getElementById('modal-item-name');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemName = itemNameElement.textContent.replace('Fotos: ', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openPhotoModal(currentItemKeyForPhoto, itemName, currentAppView === 'accounting');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(lightboxIsOpen) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lightboxSourceList = currentData.item_photos?.[currentItemKeyForPhoto] || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentLightboxIndex >= lightboxSourceList.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeLightbox();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateLightboxPhoto();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FunÃ§Ãµes de NavegaÃ§Ã£o e VisÃ£o ---
Â  Â  Â  Â  function showContentView(viewSelector) {
Â  Â  Â  Â  Â  Â  if (isMobile()) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector(viewSelector).classList.add('content-visible');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showListView(viewSelector) {
Â  Â  Â  Â  Â  Â  if (isMobile()) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector(viewSelector).classList.remove('content-visible');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function showMainView() {
Â  Â  Â  Â  Â  Â  currentAppView = 'main';
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.remove('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('item-registration-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMainViewFromRegistration() {
Â  Â  Â  Â  Â  Â  currentAppView = 'main';
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.remove('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('item-registration-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  if (!isMobile()) {
Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showListView('#main-view');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showAccountingView() {
Â  Â  Â  Â  Â  Â  currentAppView = 'accounting';
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-view').classList.remove('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('item-registration-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  settingsDropdown.classList.add('d-none');
Â  Â  Â  Â  Â  Â  renderAccountingXMLList();
Â  Â  Â  Â  Â  Â  resetToAccountingWelcomeView();
Â  Â  Â  Â  }

Â  Â  Â  Â  function showItemRegistrationView() {
Â  Â  Â  Â  Â  Â  currentAppView = 'registration';
Â  Â  Â  Â  Â  Â  document.getElementById('main-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-view').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('item-registration-view').classList.remove('d-none');
Â  Â  Â  Â  Â  Â  if (isMobile()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.querySelector('#item-registration-view').style.transform = 'translateX(-100%)';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  settingsDropdown.classList.add('d-none');
Â  Â  Â  Â  Â  Â  clearRegistrationForm();
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetToWelcomeView() {
Â  Â  Â  Â  Â  Â  showListView('#main-view');
Â  Â  Â  Â  Â  Â  document.getElementById('xml-content').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('welcome-message').style.display = 'flex';
Â  Â  Â  Â  Â  Â  currentViewMode = 'single';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#xml-list li.selected').forEach(li => li.classList.remove('selected'));
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function resetToAccountingWelcomeView() {
Â  Â  Â  Â  Â  Â  showListView('#accounting-view');
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-xml-content').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-welcome-message').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#accounting-xml-list li.selected').forEach(li => li.classList.remove('selected'));
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ãµes de Dados ---
Â  Â  Â  Â  async function fetchData() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/data`);
Â  Â  Â  Â  Â  Â  Â  Â  currentData = await response.json();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao buscar dados:', error);
Â  Â  Â  Â  Â  Â  Â  Â  alert('NÃ£o foi possÃ­vel carregar os dados do servidor. Verifique se o servidor Flask estÃ¡ a correr e se o IP estÃ¡ correto.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function parseXML(xmlStr) {
Â  Â  Â  Â  Â  Â  const parser = new DOMParser();
Â  Â  Â  Â  Â  Â  return parser.parseFromString(xmlStr, "application/xml");
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- RenderizaÃ§Ã£o na UI ---
Â  Â  Â  Â  function renderXMLList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('xml-list');
Â  Â  Â  Â  Â  Â  const selectedId = document.querySelector('#xml-list li.selected')?.dataset.id;
Â  Â  Â  Â  Â  Â  const checkedIds = new Set(Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value));
Â  Â  Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const activeXmls = (currentData.xmls || []).filter(xml => !xml.finished);
Â  Â  Â  Â  Â  Â  const sortedXmls = activeXmls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

Â  Â  Â  Â  Â  Â  if (sortedXmls.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<li style="cursor: default; color: #6c757d; padding: 1rem 1.5rem;">Nenhuma nota para conferir.</li>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â sortedXmls.forEach(xml => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = createXmlListItem(xml, false, checkedIds.has(xml.id));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(xml.id === selectedId) li.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('main-list-controls').style.display = sortedXmls.length > 0 ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  filterXMLList('#xml-list', document.getElementById('search-xml-input').value);
Â  Â  Â  Â  Â  Â  updateSelectionControls();
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderAccountingXMLList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('accounting-xml-list');
Â  Â  Â  Â  Â  Â  const selectedId = document.querySelector('#accounting-xml-list li.selected')?.dataset.id;
Â  Â  Â  Â  Â  Â  list.innerHTML = '';

Â  Â  Â  Â  Â  Â  const finishedXmls = (currentData.xmls || []).filter(xml => xml.finished);
Â  Â  Â  Â  Â  Â  const sortedXmls = finishedXmls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

Â  Â  Â  Â  Â  Â  if (sortedXmls.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<li style="cursor: default; color: #6c757d; padding: 1rem 1.5rem;">Nenhuma nota arquivada.</li>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â sortedXmls.forEach(xml => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = createXmlListItem(xml, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(xml.id === selectedId) li.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function createXmlListItem(xml, isAccounting, isChecked = false) {
Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  li.dataset.id = xml.id;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xml.xmlContent);
Â  Â  Â  Â  Â  Â  const nfeNum = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A';
Â  Â  Â  Â  Â  Â  const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
Â  Â  Â  Â  Â  Â  const supplierName = emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'Nome nÃ£o encontrado';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const checkboxHtml = isAccounting ? '' : `<input type="checkbox" class="xml-checkbox" value="${xml.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectionControls()">`;
Â  Â  Â  Â  Â  Â  const clickHandler = isAccounting ? `displayFinishedXMLContent('${xml.id}')` : `displayXMLContent('${xml.id}')`;

Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  ${checkboxHtml}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="xml-list-item-content" onclick="${clickHandler}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color: var(--primary-color); display: block;">NFe: ${nfeNum}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 0.85em; color: var(--secondary-color);">${supplierName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  li.title = `Ficheiro original: ${xml.fileName}`;
Â  Â  Â  Â  Â  Â  return li;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function filterXMLList(listSelector, filterText) {
Â  Â  Â  Â  Â  Â  filterText = filterText.toLowerCase();
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`${listSelector} li`).forEach(li => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!li.querySelector('strong')) return;
Â  Â  Â  Â  Â  Â  Â  Â  const nfeNum = li.querySelector('strong').textContent.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  const supplierName = li.querySelector('span').textContent.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  li.style.display = (nfeNum.includes(filterText) || supplierName.includes(filterText)) ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function displayXMLContent(xmlId) {
Â  Â  Â  Â  Â  Â  currentViewMode = 'single';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#xml-list li .xml-checkbox').forEach(cb => cb.checked = false);
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#xml-list li').forEach(li => li.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  document.querySelector(`#xml-list li[data-id="${xmlId}"]`)?.classList.add('selected');

Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(x => x.id === xmlId);
Â  Â  Â  Â  Â  Â  if (!xmlData || xmlData.finished) {
Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  showContentView('#main-view');
Â  Â  Â  Â  Â  Â  document.getElementById('welcome-message').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('xml-content').style.display = 'block';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  setupItemView(xmlId, xmlDoc);
Â  Â  Â  Â  Â  Â  updateSelectionControls();
Â  Â  Â  Â  }

Â  Â  Â  Â  function displayMultipleXMLs() {
Â  Â  Â  Â  Â  Â  const selectedIds = Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  if (selectedIds.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  currentViewMode = 'multiple';
Â  Â  Â  Â  Â  Â  showContentView('#main-view');
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#xml-list li').forEach(li => li.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  document.getElementById('welcome-message').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('xml-content').style.display = 'block';

Â  Â  Â  Â  Â  Â  document.getElementById('nfe-filename').textContent = `${selectedIds.length} Notas Fiscais Selecionadas`;
Â  Â  Â  Â  Â  Â  document.getElementById('nfe-details').innerHTML = 'VisualizaÃ§Ã£o combinada de mÃºltiplos ficheiros.';
Â  Â  Â  Â  Â  Â  document.getElementById('view-all-photos-btn').classList.add('d-none');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const actionBtn = document.getElementById('main-action-btn');
Â  Â  Â  Â  Â  Â  actionBtn.textContent = "Finalizar SeleÃ§Ã£o";
Â  Â  Â  Â  Â  Â  actionBtn.className = 'btn btn-success';
Â  Â  Â  Â  Â  Â  actionBtn.onclick = finishSelectedXMLs;
Â  Â  Â  Â  Â  Â  actionBtn.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('sort-items-btn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-trigger-btn').disabled = false;

Â  Â  Â  Â  Â  Â  const sortBtn = document.getElementById('sort-items-btn');
Â  Â  Â  Â  Â  Â  sortBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isItemsSorted = !isItemsSorted;
Â  Â  Â  Â  Â  Â  Â  Â  sortBtn.textContent = isItemsSorted ? 'Ordem Original' : 'Organizar A-Z';
Â  Â  Â  Â  Â  Â  Â  Â  displayMultipleXMLs(); // Re-render sorted table
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const tbody = document.querySelector('#items-table tbody');
Â  Â  Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let allItems = [];
Â  Â  Â  Â  Â  Â  selectedIds.forEach(xmlId => {
Â  Â  Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(x => x.id === xmlId);
Â  Â  Â  Â  Â  Â  Â  Â  if (!xmlData) return;
Â  Â  Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  Â  Â  const items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
Â  Â  Â  Â  Â  Â  Â  Â  items.forEach(item => allItems.push({xmlId, itemNode: item}));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (isItemsSorted) {
Â  Â  Â  Â  Â  Â  Â  Â  allItems.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nameA = a.itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nameB = b.itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return nameA.localeCompare(nameB);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  allItems.forEach(itemData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â appendItemsToTable(itemData.xmlId, [itemData.itemNode], '#items-table tbody', false);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }


Â  Â  Â  Â  function displayFinishedXMLContent(xmlId) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#accounting-xml-list li').forEach(li => li.classList.toggle('selected', li.dataset.id === xmlId));
Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(x => x.id === xmlId);
Â  Â  Â  Â  Â  Â  if (!xmlData || !xmlData.finished) {
Â  Â  Â  Â  Â  Â  Â  Â  resetToAccountingWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  showContentView('#accounting-view');
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-welcome-message').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-xml-content').style.display = 'block';

Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const ide = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'ide')[0];
Â  Â  Â  Â  Â  Â  const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-nfe-filename').textContent = `Nota Fiscal: ${ide?.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A'}`;
Â  Â  Â  Â  Â  Â  document.getElementById('accounting-nfe-details').innerHTML = `<strong>Emitente:</strong> ${emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'N/A'}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const allPhotosBtn = document.getElementById('accounting-view-all-photos-btn');
Â  Â  Â  Â  Â  Â  const allNFePhotos = getAllPhotosForNFe(xmlId);
Â  Â  Â  Â  Â  Â  if (allNFePhotos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.onclick = () => openAllPhotosModal(allNFePhotos, xmlData.fileName);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.classList.add('d-none');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('accounting-main-action-btn').onclick = () => unfinishXML(xmlId);
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-btn').onclick = () => openWizard(xmlId);
Â  Â  Â  Â  Â  Â  document.getElementById('delete-finished-xml-btn').onclick = () => deleteFinishedXML(xmlId);

Â  Â  Â  Â  Â  Â  renderItemsTable(xmlId, xmlDoc, '#accounting-items-table tbody', true);
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupItemView(xmlId, xmlDoc) {
Â  Â  Â  Â  Â  Â  isItemsSorted = false;
Â  Â  Â  Â  Â  Â  document.getElementById('filter-input').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filter-input').onkeyup = () => filterTable('#items-table', document.getElementById('filter-input').value);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const actionBtn = document.getElementById('main-action-btn');
Â  Â  Â  Â  Â  Â  actionBtn.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  actionBtn.textContent = 'Finalizar';
Â  Â  Â  Â  Â  Â  actionBtn.className = 'btn btn-success';
Â  Â  Â  Â  Â  Â  actionBtn.onclick = () => finishXML(xmlId);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('sort-items-btn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-trigger-btn').disabled = false;


Â  Â  Â  Â  Â  Â  const ide = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'ide')[0];
Â  Â  Â  Â  Â  Â  const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('nfe-filename').textContent = `Nota Fiscal: ${ide?.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A'}`;
Â  Â  Â  Â  Â  Â  document.getElementById('nfe-details').innerHTML = `<strong>Emitente:</strong> ${emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'N/A'}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const allPhotosBtn = document.getElementById('view-all-photos-btn');
Â  Â  Â  Â  Â  Â  const allNFePhotos = getAllPhotosForNFe(xmlId);
Â  Â  Â  Â  Â  Â  if (allNFePhotos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.onclick = () => openAllPhotosModal(allNFePhotos, currentData.xmls.find(x => x.id === xmlId).fileName);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  allPhotosBtn.classList.add('d-none');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const sortBtn = document.getElementById('sort-items-btn');
Â  Â  Â  Â  Â  Â  sortBtn.textContent = 'Organizar A-Z';
Â  Â  Â  Â  Â  Â  sortBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isItemsSorted = !isItemsSorted;
Â  Â  Â  Â  Â  Â  Â  Â  sortBtn.textContent = isItemsSorted ? 'Ordem Original' : 'Organizar A-Z';
Â  Â  Â  Â  Â  Â  Â  Â  renderItemsTable(xmlId, xmlDoc, '#items-table tbody', false);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  renderItemsTable(xmlId, xmlDoc, '#items-table tbody', false);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderItemsTable(xmlId, xmlDoc, tableBodySelector, isReadOnly) {
Â  Â  Â  Â  Â  Â  const tbody = document.querySelector(tableBodySelector);
Â  Â  Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  Â  Â  let items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
Â  Â  Â  Â  Â  Â  if (isItemsSorted && !isReadOnly) {
Â  Â  Â  Â  Â  Â  Â  Â  items.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nameA = a.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nameB = b.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return nameA.localeCompare(nameB);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  appendItemsToTable(xmlId, items, tableBodySelector, isReadOnly);
Â  Â  Â  Â  Â  Â  if (!isReadOnly) filterTable('#items-table', document.getElementById('filter-input').value);
Â  Â  Â  Â  }

Â  Â  Â  Â  function appendItemsToTable(xmlId, items, tableBodySelector, isReadOnly) {
Â  Â  Â  Â  Â  Â  const tbody = document.querySelector(tableBodySelector);
Â  Â  Â  Â  Â  Â  for (const item of items) {
Â  Â  Â  Â  Â  Â  Â  Â  const prod = item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
Â  Â  Â  Â  Â  Â  Â  Â  const cProd = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!cProd) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Item sem cProd encontrado e ignorado:", prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const prodName = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const photos = currentData.item_photos?.[cProd] || [];
Â  Â  Â  Â  Â  Â  Â  Â  let photoCellHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  const clickHandler = `openPhotoModal('${cProd}', '${prodName.replace(/'/g, "\\'")}', ${isReadOnly})`;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (isReadOnly) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â photoCellHtml = photos.length > 0 ? `<div class="thumbnail-container" onclick="${clickHandler}"><img src="${photos[0]}" class="thumbnail-img"></div>` : 'Sem Fotos';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (photos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photoCellHtml = `<button class="btn btn-sm" onclick="${clickHandler}">Adicionar</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let thumbnailsHtml = `<img src="${photos[0]}" class="thumbnail-img">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (photos.length > 1) thumbnailsHtml += `<span class="thumbnail-counter">+${photos.length - 1}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photoCellHtml = `<div class="thumbnail-container" onclick="${clickHandler}">${thumbnailsHtml}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const row = tbody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  row.dataset.cprod = cProd;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Fotos" class="photo-cell">${photoCellHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="CÃ³d.">${cProd}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="DescriÃ§Ã£o">${prodName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Unid." class="unit-cell">${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'uCom')[0]?.textContent || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Qtd.">${parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'qCom')[0]?.textContent || 0).toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Recebido"><input type="number" class="quantity-input" data-cprod="${cProd}" onchange="saveReceivedQty(this.dataset.cprod, this.value)" value="${currentData.received_qtys?.[cProd] || ''}" ${isReadOnly ? 'disabled' : ''}></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="EAN">${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function filterTable(tableSelector, filterText) {
Â  Â  Â  Â  Â  Â  filterText = filterText.toLowerCase();
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`${tableSelector} tbody tr`).forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  const descCell = isMobile() ? row.querySelector('td[data-label="DescriÃ§Ã£o"]') : row.cells[2];
Â  Â  Â  Â  Â  Â  Â  Â  const codeCell = isMobile() ? row.querySelector('td[data-label="CÃ³d."]') : row.cells[1];
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const desc = descCell?.textContent.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const code = codeCell?.textContent.toLowerCase() || '';

Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = (code.includes(filterText) || desc.includes(filterText)) ? '' : 'none';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function getAllPhotosForNFe(xmlId) {
Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(x => x.id === xmlId);
Â  Â  Â  Â  Â  Â  if (!xmlData) return [];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  const items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
Â  Â  Â  Â  Â  Â  const cProdSet = new Set(items.map(item => item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0]?.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent).filter(Boolean));

Â  Â  Â  Â  Â  Â  let allPhotos = [];
Â  Â  Â  Â  Â  Â  cProdSet.forEach(cProd => {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentData.item_photos?.[cProd]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allPhotos = allPhotos.concat(currentData.item_photos[cProd]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return allPhotos;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- AÃ§Ãµes (upload, backup, delete, etc.) ---
Â  Â  Â  Â  document.getElementById('xml-file-input').addEventListener('change', async (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.files.length === 0) return;
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  for (const file of e.target.files) formData.append('xml_files', file);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/upload_xml`, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) fetchData();
Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro ao enviar ficheiro(s). Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  e.target.value = '';
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  function backupData() {
Â  Â  Â  Â  Â  Â  fetch(`${BASE_URL}/api/data`).then(res => res.json()).then(fullData => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataStr = JSON.stringify(fullData, null, 4);
Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([dataStr], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  Â  Â  a.download = `backup_nfe_${new Date().toISOString().split('T')[0]}.json`;
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('restore-file-input').addEventListener('change', async (e) => {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('backup_file', file);
Â  Â  Â  Â  Â  Â  if (confirm('Tem a certeza que deseja restaurar? Todos os dados atuais serÃ£o substituÃ­dos.')) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/restore`, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(response.ok) fetchData();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro ao restaurar a cÃ³pia de seguranÃ§a. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  e.target.value = '';
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  async function deleteAllData() {
Â  Â  Â  Â  Â  Â  if (confirm('ATENÃ‡ÃƒO! Esta aÃ§Ã£o Ã© irreversÃ­vel. Deseja mesmo apagar todos os dados?')) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/delete_all_data`, { method: 'DELETE' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert((await response.json()).message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro ao apagar os dados. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function deleteSelectedXMLs() {
Â  Â  Â  Â  Â  Â  const selectedIds = Array.from(document.querySelectorAll('#main-list-controls .xml-checkbox:checked')).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  if (selectedIds.length === 0 || !confirm(`Tem a certeza que deseja apagar os ${selectedIds.length} item(ns) selecionado(s)?`)) return;
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/xmls/delete`, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {'Content-Type': 'application/json'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ ids: selectedIds })
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  if(response.ok) resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  alert((await response.json()).message);
Â  Â  Â  Â  Â  Â  Â } catch (error) { alert('Erro ao apagar os itens selecionados. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function deleteFinishedXML(xmlId) {
Â  Â  Â  Â  Â  Â  if (!xmlId) return;
Â  Â  Â  Â  Â  Â  if (confirm('Tem a certeza que deseja excluir PERMANENTEMENTE esta nota fiscal e todos os seus dados associados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/xml/delete/${xmlId}`, { method: 'DELETE' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetToAccountingWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao excluir a nota fiscal:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Erro de comunicaÃ§Ã£o ao excluir a nota fiscal. Verifique a conexÃ£o com o servidor.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveReceivedQty(cProd, quantity) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/save_received_qty`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ cProd, quantity: parseFloat(quantity) })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('O servidor respondeu com um erro:', response.status);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Detalhes do erro:', errorData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Ocorreu um erro no servidor ao guardar a quantidade. Status: ${response.status}. Verifique a conexÃ£o.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro de rede ao guardar a quantidade:', error);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Erro de comunicaÃ§Ã£o ao guardar a quantidade recebida. Verifique a conexÃ£o com o servidor.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function finishXML(xmlId) {
Â  Â  Â  Â  Â  Â  if (confirm('Tem a certeza que deseja finalizar esta nota? Ela serÃ¡ movida para a Contabilidade.')) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/xmls/finish`, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {'Content-Type': 'application/json'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ ids: [xmlId] })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert((await response.json()).message);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro de comunicaÃ§Ã£o ao finalizar a nota. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function finishSelectedXMLs() {
Â  Â  Â  Â  Â  Â  const selectedIds = Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  if (selectedIds.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Nenhuma nota selecionada para finalizar.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (confirm(`Tem a certeza que deseja finalizar as ${selectedIds.length} notas selecionadas? Elas serÃ£o movidas para a Contabilidade.`)) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/xmls/finish`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ ids: selectedIds })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetToWelcomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert((await response.json()).message);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro de comunicaÃ§Ã£o ao finalizar as notas. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function unfinishXML(xmlId) {
Â  Â  Â  Â  Â  Â  Â if (confirm('Tem a certeza que deseja reabrir esta nota? Ela voltarÃ¡ para a tela de conferÃªncia.')) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/xml/unfinish/${xmlId}`, { method: 'POST' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMainView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert((await response.json()).message);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { alert('Erro de comunicaÃ§Ã£o ao reabrir a nota. Verifique a conexÃ£o com o servidor.'); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateSelectionControls() {
Â  Â  Â  Â  Â  Â  const allCheckboxes = document.querySelectorAll('#main-list-controls .xml-checkbox');
Â  Â  Â  Â  Â  Â  const checkedCheckboxes = document.querySelectorAll('#main-list-controls .xml-checkbox:checked');
Â  Â  Â  Â  Â  Â  const selectAllCheckbox = document.getElementById('select-all-checkbox');
Â  Â  Â  Â  Â  Â  const deleteSelectedBtn = document.getElementById('delete-selected-btn');

Â  Â  Â  Â  Â  Â  if (checkedCheckboxes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  deleteSelectedBtn.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  deleteSelectedBtn.classList.add('d-none');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!selectAllCheckbox) return;
Â  Â  Â  Â  Â  Â  selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleSelectAll(checked, selector) {
Â  Â  Â  Â  Â  Â  Â document.querySelectorAll(selector).forEach(checkbox => {
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = checked;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updateSelectionControls();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ãµes de Fotos e Modais ---
Â  Â  Â  Â  function openPhotoModal(cProd, itemName, isReadOnly) {
Â  Â  Â  Â  Â  Â  currentItemKeyForPhoto = cProd;
Â  Â  Â  Â  Â  Â  lightboxSourceList = currentData.item_photos?.[cProd] || [];
Â  Â  Â  Â  Â  Â  document.getElementById('modal-item-name').textContent = `Fotos: ${itemName}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const addPhotoBtn = document.getElementById('add-photo-btn');
Â  Â  Â  Â  Â  Â  const photoInput = document.getElementById('photo-input');
Â  Â  Â  Â  Â  Â  addPhotoBtn.style.display = isReadOnly ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  // O clique no botÃ£o agora simplesmente abre o input de arquivo, que gerencia a cÃ¢mera/galeria
Â  Â  Â  Â  Â  Â  addPhotoBtn.onclick = () => photoInput.click();

Â  Â  Â  Â  Â  Â  const gallery = document.getElementById('photo-gallery');
Â  Â  Â  Â  Â  Â  gallery.innerHTML = '';
Â  Â  Â  Â  Â  Â  lightboxSourceList.forEach((photoBase64, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = 'gallery-item';
Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtnHtml = isReadOnly ? '' : `<button class="delete-photo-btn" title="Apagar foto" onclick="deletePhoto(event, '${cProd}', ${index})">&times;</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `<img src="${photoBase64}" onclick="openLightbox(event, ${index}, '${cProd}', ${isReadOnly})">${deleteBtnHtml}`;
Â  Â  Â  Â  Â  Â  Â  Â  gallery.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('photo-modal').style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function deletePhoto(event, cProd, index) {
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  if (!cProd || !confirm('Tem a certeza que deseja apagar esta foto?')) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/delete_photo`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ cProd, photoIndex: index })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ message: 'Resposta invÃ¡lida do servidor.' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Erro ao apagar a foto: ${errorData.message}. Verifique a conexÃ£o com o servidor.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (document.getElementById('lightbox').style.display === 'flex') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeLightbox();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) { 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro de comunicaÃ§Ã£o ao apagar foto:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Erro de comunicaÃ§Ã£o ao apagar a foto. Verifique a conexÃ£o com o servidor.'); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function openAllPhotosModal(allPhotos, nfeName) {
Â  Â  Â  Â  Â  Â  currentItemKeyForPhoto = null;
Â  Â  Â  Â  Â  Â  lightboxSourceList = allPhotos;
Â  Â  Â  Â  Â  Â  document.getElementById('modal-item-name').textContent = `Todas as Fotos: ${nfeName}`;
Â  Â  Â  Â  Â  Â  document.getElementById('add-photo-btn').style.display = 'none';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const gallery = document.getElementById('photo-gallery');
Â  Â  Â  Â  Â  Â  gallery.innerHTML = '';
Â  Â  Â  Â  Â  Â  allPhotos.forEach((photoBase64, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = 'gallery-item';
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `<img src="${photoBase64}" onclick="openLightbox(event, ${index}, null, true)">`; 
Â  Â  Â  Â  Â  Â  Â  Â  gallery.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('photo-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('photo-modal').style.display = 'none';
Â  Â  Â  Â  Â  Â  currentItemKeyForPhoto = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function openLightbox(event, index, cProd, isReadOnly) {
Â  Â  Â  Â  Â  Â  event.stopPropagation(); // Evita o clique no item da galeria subjacente
Â  Â  Â  Â  Â  Â  currentItemKeyForPhoto = cProd;Â 
Â  Â  Â  Â  Â  Â  if (cProd) {
Â  Â  Â  Â  Â  Â  Â  Â  lightboxSourceList = currentData.item_photos?.[cProd] || [];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  currentLightboxIndex = index;
Â  Â  Â  Â  Â  Â  document.getElementById('lightbox').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.getElementById('lightbox-delete').style.display = (isReadOnly || !cProd) ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  updateLightboxPhoto();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function closeLightbox() {
Â  Â  Â  Â  Â  Â  document.getElementById('lightbox').style.display = 'none';
Â  Â  Â  Â  Â  Â  currentLightboxIndex = -1;
Â  Â  Â  Â  }
Â  Â  Â  Â  function navigateLightbox(direction) {
Â  Â  Â  Â  Â  Â  if (lightboxSourceList.length === 0) return;
Â  Â  Â  Â  Â  Â  currentLightboxIndex = (currentLightboxIndex + direction + lightboxSourceList.length) % lightboxSourceList.length;
Â  Â  Â  Â  Â  Â  updateLightboxPhoto();
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateLightboxPhoto() {
Â  Â  Â  Â  Â  Â  if(currentLightboxIndex > -1 && currentLightboxIndex < lightboxSourceList.length) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('lightbox-img').src = lightboxSourceList[currentLightboxIndex];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  closeLightbox();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function deleteCurrentLightboxPhoto() {
Â  Â  Â  Â  Â  Â  if(currentLightboxIndex > -1 && currentItemKeyForPhoto) {
Â  Â  Â  Â  Â  Â  Â  Â  deletePhoto(new Event('delete'), currentItemKeyForPhoto, currentLightboxIndex);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- WIZARD ---
Â  Â  Â  Â  function openWizard(xmlId) {
Â  Â  Â  Â  Â  Â  wizardCurrentXmlId = xmlId;
Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(x => x.id === xmlId);
Â  Â  Â  Â  Â  Â  if (!xmlData) return;
Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  wizardItems = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
Â  Â  Â  Â  Â  Â  wizardCurrentIndex = 0;
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-modal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-prev').onclick = () => navigateWizard(-1);
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-next').onclick = () => navigateWizard(1);
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-photo-prev').onclick = () => navigateWizardPhotos(-1);
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-photo-next').onclick = () => navigateWizardPhotos(1);
Â  Â  Â  Â  Â  Â  renderWizardItem();
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeWizard() {
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-modal').style.display = 'none';
Â  Â  Â  Â  Â  Â  wizardItems = [];
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function navigateWizard(direction) {
Â  Â  Â  Â  Â  Â  wizardCurrentIndex += direction;
Â  Â  Â  Â  Â  Â  renderWizardItem();
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderWizardItem() {
Â  Â  Â  Â  Â  Â  wizardPhotoIndex = 0;
Â  Â  Â  Â  Â  Â  if (wizardCurrentIndex < 0 || wizardCurrentIndex >= wizardItems.length) {
Â  Â  Â  Â  Â  Â  Â  Â  closeWizard();Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const item = wizardItems[wizardCurrentIndex];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const prod = item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
Â  Â  Â  Â  Â  Â  const vUnCom = parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'vUnCom')[0]?.textContent || 0);
Â  Â  Â  Â  Â  Â  const qCom = parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'qCom')[0]?.textContent || 0);
Â  Â  Â  Â  Â  Â  const cProd = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent || '';

Â  Â  Â  Â  Â  Â  const body = document.getElementById('wizard-body');
Â  Â  Â  Â  Â  Â  body.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>CÃ³digo:</strong> <span>${cProd}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>DescriÃ§Ã£o:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || ''}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>EAN:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || 'N/A'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>Unidade:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'uCom')[0]?.textContent || ''}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>Quantidade:</strong> <span>${qCom.toFixed(2)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>PreÃ§o UnitÃ¡rio:</strong> <span>R$ ${vUnCom.toFixed(2)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-item-info"><strong>PreÃ§o Total:</strong> <span>R$ ${(vUnCom * qCom).toFixed(2)}</span></div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  document.getElementById('wizard-counter').textContent = `Item ${wizardCurrentIndex + 1} de ${wizardItems.length}`;
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-prev').disabled = wizardCurrentIndex === 0;
Â  Â  Â  Â  Â  Â  document.getElementById('wizard-next').disabled = wizardCurrentIndex === wizardItems.length - 1;
Â  Â  Â  Â  Â  Â  renderWizardPhotos(cProd);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderWizardPhotos(cProd) {
Â  Â  Â  Â  Â  Â  if (!cProd) return;
Â  Â  Â  Â  Â  Â  const photos = currentData.item_photos?.[cProd] || [];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const photoViewer = document.getElementById('wizard-photo-viewer');
Â  Â  Â  Â  Â  Â  const photoStrip = document.getElementById('wizard-photo-strip');
Â  Â  Â  Â  Â  Â  const prevBtn = document.getElementById('wizard-photo-prev');
Â  Â  Â  Â  Â  Â  const nextBtn = document.getElementById('wizard-photo-next');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  photoStrip.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (photos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  photoViewer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  photoViewer.style.display = 'flex';

Â  Â  Â  Â  Â  Â  const photosToShow = photos.slice(wizardPhotoIndex, wizardPhotoIndex + 2);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  photosToShow.forEach((photoSrc, localIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  Â  Â  Â  img.src = photoSrc;
Â  Â  Â  Â  Â  Â  Â  Â  const globalPhotoIndex = wizardPhotoIndex + localIndex;
Â  Â  Â  Â  Â  Â  Â  Â  img.onclick = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lightboxSourceList = photos;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openLightbox(event, globalPhotoIndex, cProd, true);Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  photoStrip.appendChild(img);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  prevBtn.disabled = wizardPhotoIndex <= 0;
Â  Â  Â  Â  Â  Â  nextBtn.disabled = wizardPhotoIndex >= photos.length - 2;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (photos.length <= 2) {
Â  Â  Â  Â  Â  Â  Â  Â  prevBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  prevBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function navigateWizardPhotos(direction) {
Â  Â  Â  Â  Â  Â  wizardPhotoIndex += direction;
Â  Â  Â  Â  Â  Â  renderWizardPhotos(wizardItems[wizardCurrentIndex].getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0]?.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- START: FunÃ§Ãµes de ConferÃªncia Manual ---
Â  Â  Â  Â  
Â  Â  Â  Â  function clearManualCheckForm(isNewEan = true) {
Â  Â  Â  Â  Â  Â  currentManualCheckCProd = null;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-details').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('manual-item-selector-container').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-error').classList.add('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('finish-item-btn').disabled = true;

Â  Â  Â  Â  Â  Â  if (isNewEan) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-ean').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-ean').focus();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-desc').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-qty').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-unit-factor').value = '1';
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-received-qty').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-unit-type').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-photo-gallery').innerHTML = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function openManualCheckView() {
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-view').style.display = 'flex';
Â  Â  Â  Â  Â  Â  clearManualCheckForm();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function hideManualCheckView() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('manual-check-view').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function pasteEan() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const text = await navigator.clipboard.readText();
Â  Â  Â  Â  Â  Â  Â  Â  const eanInput = document.getElementById('manual-check-ean');
Â  Â  Â  Â  Â  Â  Â  Â  eanInput.value = text;
Â  Â  Â  Â  Â  Â  Â  Â  eanInput.dispatchEvent(new Event('input', { bubbles: true })); // Dispara o evento para procurar o item
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Falha ao colar texto: ', err);
Â  Â  Â  Â  Â  Â  Â  Â  alert('NÃ£o foi possÃ­vel ler da Ã¡rea de transferÃªncia. Verifique as permissÃµes do seu navegador.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function findItemByEan(ean) {
Â  Â  Â  Â  Â  Â  if (!ean) {
Â  Â  Â  Â  Â  Â  Â  Â  clearManualCheckForm(false);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const rows = document.querySelectorAll('#items-table tbody tr');
Â  Â  Â  Â  Â  Â  let foundRow = null;

Â  Â  Â  Â  Â  Â  for (const row of rows) {
Â  Â  Â  Â  Â  Â  Â  Â  const eanCell = isMobile() ? row.querySelector('td[data-label="EAN"]') : row.cells[6];
Â  Â  Â  Â  Â  Â  Â  Â  if (eanCell && eanCell.textContent.trim() === ean) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foundRow = row;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const errorDiv = document.getElementById('manual-check-error');
Â  Â  Â  Â  Â  Â  const selectorContainer = document.getElementById('manual-item-selector-container');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (foundRow) {
Â  Â  Â  Â  Â  Â  Â  Â  errorDiv.classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  selectorContainer.classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  populateManualCheckForm(foundRow);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  errorDiv.textContent = 'EAN nÃ£o encontrado. Associe-o a um item da lista:';
Â  Â  Â  Â  Â  Â  Â  Â  errorDiv.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-details').classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('finish-item-btn').disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  const selector = document.getElementById('manual-item-selector');
Â  Â  Â  Â  Â  Â  Â  Â  selector.innerHTML = '<option value="">Selecione um item...</option>';Â 

Â  Â  Â  Â  Â  Â  Â  Â  rows.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cProd = row.dataset.cprod;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!cProd) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const desc = (isMobile() ? row.querySelector('td[data-label="DescriÃ§Ã£o"]').textContent : row.cells[2].textContent).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.value = cProd;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = `${cProd} - ${desc}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selector.appendChild(option);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  selectorContainer.classList.remove('d-none');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleManualItemSelection() {
Â  Â  Â  Â  Â  Â  const selector = document.getElementById('manual-item-selector');
Â  Â  Â  Â  Â  Â  const selectedCProd = selector.value;
Â  Â  Â  Â  Â  Â  if (!selectedCProd) return;

Â  Â  Â  Â  Â  Â  const foundRow = document.querySelector(`#items-table tbody tr[data-cprod="${selectedCProd}"]`);
Â  Â  Â  Â  Â  Â  if (foundRow) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-error').classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('manual-item-selector-container').classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  populateManualCheckForm(foundRow);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function populateManualCheckForm(row) {
Â  Â  Â  Â  Â  Â  const cProd = row.dataset.cprod;
Â  Â  Â  Â  Â  Â  if (!cProd) return;
Â  Â  Â  Â  Â  Â  currentManualCheckCProd = cProd;

Â  Â  Â  Â  Â  Â  const desc = (isMobile() ? row.querySelector('td[data-label="DescriÃ§Ã£o"]').textContent : row.cells[2].textContent).trim();
Â  Â  Â  Â  Â  Â  const unit = (isMobile() ? row.querySelector('td[data-label="Unid."]').textContent : row.cells[3].textContent).trim();
Â  Â  Â  Â  Â  Â  const qty = (isMobile() ? row.querySelector('td[data-label="Qtd."]').textContent : row.cells[4].textContent).trim();
Â  Â  Â  Â  Â  Â  const receivedQtyInput = row.querySelector('.quantity-input');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-details').classList.remove('d-none');
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-desc').value = desc;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-qty').value = qty;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-unit-type').value = unit;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-received-qty').value = receivedQtyInput.value;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  renderManualCheckPhotoGallery(cProd);

Â  Â  Â  Â  Â  Â  document.getElementById('finish-item-btn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-received-qty').focus();
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderManualCheckPhotoGallery(cProd) {
Â  Â  Â  Â  Â  Â  const gallery = document.getElementById('manual-check-photo-gallery');
Â  Â  Â  Â  Â  Â  gallery.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (!cProd) return;

Â  Â  Â  Â  Â  Â  const photos = currentData.item_photos?.[cProd] || [];
Â  Â  Â  Â  Â  Â  photos.forEach((photoBase64, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = 'gallery-item';
Â  Â  Â  Â  Â  Â  Â  Â  const deleteBtnHtml = `<button class="delete-photo-btn" title="Apagar foto" onclick="deleteManualCheckPhoto(event, '${cProd}', ${index})">&times;</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `<img src="${photoBase64}">${deleteBtnHtml}`;
Â  Â  Â  Â  Â  Â  Â  Â  gallery.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function deleteManualCheckPhoto(event, cProd, index) {
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  if (!cProd || !confirm('Tem a certeza que deseja apagar esta foto?')) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(currentData.item_photos?.[cProd]) {
Â  Â  Â  Â  Â  Â  Â  Â  currentData.item_photos[cProd].splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  Â  renderManualCheckPhotoGallery(cProd);Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/delete_photo`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ cProd, photoIndex: index })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Erro ao apagar a foto. Verifique a conexÃ£o com o servidor.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchData();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) { 
Â  Â  Â  Â  Â  Â  Â  Â  alert('Erro de comunicaÃ§Ã£o ao apagar a foto. Verifique a conexÃ£o com o servidor.'); 
Â  Â  Â  Â  Â  Â  Â  Â  fetchData();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function finishManualCheckItem() {
Â  Â  Â  Â  Â  Â  if (!currentManualCheckCProd) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const receivedQty = document.getElementById('manual-check-received-qty').value;
Â  Â  Â  Â  Â  Â  const factor = parseFloat(document.getElementById('manual-check-unit-factor').value) || 1;
Â  Â  Â  Â  Â  Â  const finalQty = parseFloat(receivedQty) * factor;

Â  Â  Â  Â  Â  Â  const mainTableInput = document.querySelector(`#items-table .quantity-input[data-cprod="${currentManualCheckCProd}"]`);
Â  Â  Â  Â  Â  Â  if (mainTableInput) {
Â  Â  Â  Â  Â  Â  Â  Â  mainTableInput.value = finalQty;
Â  Â  Â  Â  Â  Â  Â  Â  mainTableInput.closest('tr').classList.add('item-highlight');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainTableInput.closest('tr').classList.remove('item-highlight');
Â  Â  Â  Â  Â  Â  Â  Â  }, 2500);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await saveReceivedQty(currentManualCheckCProd, finalQty);
Â  Â  Â  Â  Â  Â  clearManualCheckForm();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- END: FunÃ§Ãµes de ConferÃªncia Manual ---
Â  Â  Â  Â  
Â  Â  Â  Â  async function handlePhotoUpload(event, cProd, successCallback) {
Â  Â  Â  Â  Â  Â  if (!cProd || !event.target.files || event.target.files.length === 0) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('add-photo-btn');
Â  Â  Â  Â  Â  Â  const manualBtn = document.getElementById('manual-check-add-photo-btn');
Â  Â  Â  Â  Â  Â  if (btn) { btn.textContent = 'A enviar...'; btn.disabled = true; }
Â  Â  Â  Â  Â  Â  if (manualBtn) { manualBtn.textContent = 'A enviar...'; manualBtn.disabled = true; }

Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('cProd', cProd);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  for (const file of event.target.files) {
Â  Â  Â  Â  Â  Â  Â  Â  const newFileName = `${cProd}_${Date.now()}.${file.name.split('.').pop()}`;
Â  Â  Â  Â  Â  Â  Â  Â  formData.append('photos', file, newFileName);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/save_photo`, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Erro ao guardar as fotos: ${result.message}. Verifique a conexÃ£o com o servidor.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!currentData.item_photos) currentData.item_photos = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentData.item_photos[cProd] = result.photos;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(successCallback) successCallback(cProd);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) { 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro de comunicaÃ§Ã£o ao adicionar foto:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Erro de comunicaÃ§Ã£o ao guardar as fotos. Verifique a conexÃ£o com o servidor.'); 
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  event.target.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (btn) { btn.textContent = 'Adicionar/Tirar Foto'; btn.disabled = false; }
Â  Â  Â  Â  Â  Â  Â  Â  if (manualBtn) { manualBtn.textContent = 'Adicionar/Tirar Foto'; manualBtn.disabled = false; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- FunÃ§Ãµes de Cadastro de Item ---
Â  Â  Â  Â  function clearRegistrationForm() {
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-cprod').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-ean').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-desc').value = '';
Â  Â  Â  Â  Â  Â  const preview = document.getElementById('item-reg-photo-preview');
Â  Â  Â  Â  Â  Â  preview.src = '';
Â  Â  Â  Â  Â  Â  preview.style.display = 'none';
Â  Â  Â  Â  Â  Â  itemRegPhotoBase64 = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveItemRegistration() {
Â  Â  Â  Â  Â  Â  const cprod = document.getElementById('item-reg-cprod').value.trim();
Â  Â  Â  Â  Â  Â  const ean = document.getElementById('item-reg-ean').value.trim();
Â  Â  Â  Â  Â  Â  const desc = document.getElementById('item-reg-desc').value.trim();

Â  Â  Â  Â  Â  Â  if (!cprod || !desc) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("CÃ³digo Interno e DescriÃ§Ã£o sÃ£o campos obrigatÃ³rios.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const itemData = { cprod, ean, desc, photo: itemRegPhotoBase64 };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${BASE_URL}/api/register_item`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(itemData)
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearRegistrationForm();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMainView();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar item:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Erro de comunicaÃ§Ã£o ao salvar o item. Verifique a conexÃ£o com o servidor.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function fetchItemDataFromXml() {
Â  Â  Â  Â  Â  Â  const nfeNumber = prompt("Digite o nÃºmero da NFe para buscar o item:");
Â  Â  Â  Â  Â  Â  if (!nfeNumber) return;
Â  Â  Â  Â  Â  Â  const itemNumber = prompt(`Digite o nÃºmero do item (nItem) da NFe ${nfeNumber}:`);
Â  Â  Â  Â  Â  Â  if (!itemNumber) return;

Â  Â  Â  Â  Â  Â  const xmlData = currentData.xmls.find(xml => {
Â  Â  Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xml.xmlContent);
Â  Â  Â  Â  Â  Â  Â  Â  const nfeNum = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  return nfeNum === nfeNumber;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!xmlData) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`NFe com nÃºmero ${nfeNumber} nÃ£o encontrada.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const xmlDoc = parseXML(xmlData.xmlContent);
Â  Â  Â  Â  Â  Â  const itemNode = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det')).find(det => det.getAttribute('nItem') === itemNumber);

Â  Â  Â  Â  Â  Â  if (!itemNode) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Item ${itemNumber} nÃ£o encontrado na NFe ${nfeNumber}.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const prod = itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-cprod').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-ean').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-desc').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- LÃ³gica do Dropdown e Carregamento Inicial ---
Â  Â  Â  Â  window.onload = () => {
Â  Â  Â  Â  Â  Â  const settingsBtn = document.getElementById('settings-btn');
Â  Â  Â  Â  Â  Â  const settingsDropdown = document.getElementById('settings-dropdown');
Â  Â  Â  Â  Â  Â  const accNoteSettingsBtn = document.getElementById('accounting-note-settings-btn');
Â  Â  Â  Â  Â  Â  const accNoteDropdown = document.getElementById('accounting-note-dropdown');

Â  Â  Â  Â  Â  Â  accNoteSettingsBtn.onclick = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  accNoteDropdown.classList.toggle('d-none');
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  settingsBtn.onclick = (e) => { e.stopPropagation(); settingsDropdown.classList.toggle('d-none'); }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  window.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!settingsDropdown.classList.contains('d-none') && !settingsBtn.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settingsDropdown.classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!accNoteDropdown.classList.contains('d-none') && !accNoteSettingsBtn.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accNoteDropdown.classList.add('d-none');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  fetchData().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  renderXMLList();
Â  Â  Â  Â  Â  Â  Â  Â  renderAccountingXMLList();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Event listeners principais
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-trigger-btn').addEventListener('click', openManualCheckView);
Â  Â  Â  Â  Â  Â  document.getElementById('paste-ean-btn').addEventListener('click', pasteEan);
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-ean').addEventListener('input', (e) => findItemByEan(e.target.value));
Â  Â  Â  Â  Â  Â  document.getElementById('select-item-btn').addEventListener('click', handleManualItemSelection);
Â  Â  Â  Â  Â  Â  document.getElementById('finish-item-btn').addEventListener('click', finishManualCheckItem);

Â  Â  Â  Â  Â  Â  // Event listeners para o upload de fotos (usando input type="file" com capture="environment")
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-add-photo-btn').addEventListener('click', () => document.getElementById('manual-check-photo-input').click());
Â  Â  Â  Â  Â  Â  document.getElementById('manual-check-photo-input').addEventListener('change', (e) => handlePhotoUpload(e, currentManualCheckCProd, renderManualCheckPhotoGallery));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-add-photo-btn').addEventListener('click', () => document.getElementById('item-reg-photo-input').click());
Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-photo-input').addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemRegPhotoBase64 = event.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-photo-preview').src = itemRegPhotoBase64;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('item-reg-photo-preview').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.getElementById('add-photo-btn').addEventListener('click', () => document.getElementById('photo-input').click());
Â  Â  Â  Â  Â  Â  document.getElementById('photo-input').addEventListener('change', (e) => handlePhotoUpload(e, currentItemKeyForPhoto, (cProd) => {
Â  Â  Â  Â  Â  Â  Â  Â  // ApÃ³s o upload, atualiza a galeria de fotos do modal
Â  Â  Â  Â  Â  Â  Â  Â  const itemNameElement = document.getElementById('modal-item-name');
Â  Â  Â  Â  Â  Â  Â  Â  const itemName = itemNameElement.textContent.replace('Fotos: ', '');
Â  Â  Â  Â  Â  Â  Â  Â  openPhotoModal(cProd, itemName, currentAppView === 'accounting');
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  };
Â  Â  </script>
</body>
</html>
