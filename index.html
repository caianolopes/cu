<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência de NFe - Responsivo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
            --hover-color: #f1f1f1;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --danger-light-color: #f8d7da;
            --danger-text-color: #721c24;
            --warning-light-color: #fff3cd;
            --warning-text-color: #856404;
            --white-color: #fff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --highlight-color: #cce5ff;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; /* Evita a rolagem do corpo da página */
        }

        .view-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        /* --- Coluna da Esquerda (Painel Lateral) --- */
        .sidebar {
            width: 380px;
            background-color: var(--white-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .settings-container {
            position: relative;
        }

        #settings-btn, #accounting-settings-btn {
            background: none; border: none; cursor: pointer;
            padding: 0.5rem; color: var(--secondary-color);
        }
        #settings-btn:hover, #accounting-settings-btn:hover {
            color: var(--primary-color);
        }
        
        .dropdown-content {
            position: absolute; right: 0; top: calc(100% + 5px);
            background-color: var(--white-color); min-width: 220px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15); z-index: 10;
            border-radius: 8px; border: 1px solid var(--border-color);
            padding: 0.5rem 0; overflow: hidden;
        }

        .dropdown-item {
            width: 100%; text-align: left; border: none;
            background-color: transparent; cursor: pointer;
            padding: 0.75rem 1.5rem; display: block;
        }
        .dropdown-item:hover { background-color: var(--hover-color); }

        .controls-section {
            padding: 1rem; display: grid;
            grid-template-columns: 1fr; gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem; border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--white-color); cursor: pointer;
            font-size: 0.875rem; transition: all 0.2s ease;
            text-align: center; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem;
        }

        .btn:hover {
            border-color: var(--primary-color); color: var(--primary-color);
        }
        
        .btn:disabled {
            background-color: #e9ecef; border-color: var(--border-color);
            color: var(--secondary-color); cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: var(--primary-color); color: var(--white-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #0056b3; border-color: #0056b3; color: var(--white-color);
        }

        .btn-danger {
            color: var(--danger-color); border-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: var(--danger-color); color: var(--white-color);
        }
        
        .btn-success {
            background-color: var(--success-color); color: var(--white-color);
            border-color: var(--success-color);
        }
        .btn-success:hover {
            background-color: #218838; border-color: #1e7e34;
        }

        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        .list-search-controls {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%; padding: 0.5rem; border-radius: 8px;
            border: 1px solid var(--border-color); font-size: 0.9rem;
            box-sizing: border-box;
        }

        .list-controls {
            padding: 0.75rem 1.5rem; border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color); background-color: var(--bg-color);
            display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;
        }
        
        .list-controls > div { display: flex; align-items: center; gap: 0.5rem; }
        
        .xml-list-container { flex-grow: 1; overflow-y: auto; }
        .xml-list { list-style: none; padding: 0; margin: 0; }
        .xml-list li {
            padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease; font-size: 0.9rem;
            display: flex; align-items: center; gap: 1rem;
        }
        
        .xml-list-item-content { flex-grow: 1; cursor: pointer; padding: 0.25rem 0; }
        .xml-list li:hover { background-color: var(--hover-color); }
        .xml-list li.selected { background-color: var(--primary-color); color: white; }
        .xml-list li.selected strong, .xml-list li.selected span { color: white !important; }
        
        .sidebar-footer {
            padding: 1rem; font-size: 0.8rem; color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
        }

        #auto-import-path { font-style: italic; word-break: break-all; }

        /* --- Coluna da Direita (Conteúdo Principal) --- */
        .content-area {
            flex-grow: 1; padding: 1.5rem; overflow-y: auto;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }
        
        .content-header-mobile {
            display: none; /* Oculto por padrão */
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .welcome-message {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; height: 100%; text-align: center;
            color: var(--secondary-color);
        }
        .welcome-message .icon { font-size: 4rem; margin-bottom: 1rem; }
        .xml-content { display: none; }

        .nfe-header {
            position: relative; background-color: var(--white-color);
            border-radius: 8px; border: 1px solid var(--border-color);
            padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow);
        }

        #view-all-photos-btn { position: absolute; top: 1.5rem; right: 1.5rem; }

        .items-section {
            flex-grow: 1; display: flex; flex-direction: column;
            background-color: var(--white-color); border-radius: 8px;
            border: 1px solid var(--border-color); padding: 1.5rem;
            margin-bottom: 1.5rem; box-shadow: var(--shadow);
        }
        
        .items-section-header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;
        }
        .items-section-header h3 { margin: 0; }
        .filter-input {
            padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);
            font-size: 0.9rem; flex-grow: 1; min-width: 150px;
        }
        .items-section-header .btn-group { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .items-table-container { overflow-y: auto; flex-grow: 1; }

        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 0.75rem; text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem; vertical-align: middle;
        }
        th { background-color: var(--bg-color); }
        tr.item-highlight {
            background-color: var(--highlight-color) !important;
            transition: background-color 0.3s ease;
        }

        .quantity-input {
            width: 70px; padding: 5px; border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        .quantity-input:disabled { background-color: #e9ecef; cursor: not-allowed; }

        .photo-cell { width: 140px; }
        .unit-cell { width: 60px; text-align: center; }

        .thumbnail-container {
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .thumbnail-img {
            width: 40px; height: 40px; border-radius: 4px;
            object-fit: cover; border: 1px solid var(--border-color);
        }
        .thumbnail-counter {
            width: 40px; height: 40px; border-radius: 4px; background-color: var(--hover-color);
            color: var(--secondary-color); display: flex; align-items: center;
            justify-content: center; font-weight: bold; font-size: 0.9em;
        }

        /* --- Modais --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--white-color); padding: 20px; border-radius: 8px;
            width: 90%; max-width: 500px;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .close-button { font-size: 1.5rem; font-weight: bold; cursor: pointer; }

        .modal-body {
            overflow-y: auto;
            padding-right: 10px; /* Evita que a scrollbar sobreponha o conteúdo */
        }

        #photo-gallery {
            overflow-y: auto; padding: 5px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .gallery-item { position: relative; }
        .gallery-item img {
            width: 100%; height: 100px; object-fit: cover; border-radius: 5px;
            cursor: pointer; display: block;
        }
        .delete-photo-btn {
            position: absolute; top: 5px; right: 5px; background-color: rgba(220, 53, 69, 0.8);
            color: white; border: none; border-radius: 50%; width: 24px; height: 24px;
            cursor: pointer; font-size: 14px; display: flex; align-items: center;
            justify-content: center; line-height: 1; transition: background-color 0.2s;
        }
        .delete-photo-btn:hover { background-color: var(--danger-color); }
        
        /* Lightbox */
        #lightbox {
            display: none; position: fixed; z-index: 1002; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85);
            flex-direction: column; align-items: center; justify-content: center;
        }
        #lightbox-img { max-width: 90vw; max-height: 80vh; object-fit: contain; }
        .lightbox-nav {
            cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%);
            color: white; font-size: 2.5rem; padding: 1rem; user-select: none;
            transition: background-color 0.2s;
        }
        .lightbox-nav:hover { background-color: rgba(255, 255, 255, 0.1); }
        #lightbox-prev { left: 10px; }
        #lightbox-next { right: 10px; }
        #lightbox-close { top: 15px; right: 20px; font-size: 2.5rem; }
        #lightbox-delete { top: 20px; left: 20px; background: none; border: none; color: white; font-size: 1.8rem;}

        /* Wizard Modal (Slide-in Panel) */
        #wizard-modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            justify-content: flex-end; align-items: stretch;
        }
        #wizard-content {
            width: 35%; max-width: 500px; height: 100%; background-color: var(--white-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column;
            animation: slideIn 0.3s forwards;
        }
        
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #wizard-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #wizard-body { padding: 1.5rem; overflow-y: auto; flex-shrink: 0; }
        #wizard-photo-viewer {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 1rem; position: relative; background-color: #e9ecef;
            border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
            min-height: 150px;
        }
        #wizard-photo-strip {
            display: flex; gap: 10px; height: 100%; width: 100%;
            align-items: center; justify-content: center;
        }
        #wizard-photo-strip img {
            width: 50%; height: 100%; object-fit: contain; border-radius: 4px;
            background-color: var(--white-color); cursor: pointer;
        }
        .wizard-photo-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 20px; cursor: pointer; z-index: 5;
            transition: background-color 0.2s;
        }
        .wizard-photo-nav:hover { background-color: rgba(0,0,0,0.6); }
        .wizard-photo-nav:disabled { opacity: 0.2; cursor: not-allowed; }
        #wizard-photo-prev { left: 15px; }
        #wizard-photo-next { right: 15px; }

        #wizard-footer {
            padding: 1rem 1.5rem; flex-shrink: 0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .wizard-item-info { margin-bottom: 1rem; }
        .wizard-item-info strong {
            display: block; color: var(--primary-color); margin-bottom: 0.25rem;
        }
        
        /* Item Registration View */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
        }
        #item-reg-photo-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            object-fit: contain;
            display: none; /* Hidden by default */
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        #manual-check-error {
            color: var(--danger-text-color);
            background-color: var(--danger-light-color);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* --- Estilos da Galeria de Fotos no Modal Manual --- */
        .photo-gallery-inline {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 50px;
            background-color: var(--bg-color);
        }
        .photo-gallery-inline .gallery-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .photo-gallery-inline .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        .photo-gallery-inline .delete-photo-btn {
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            font-size: 12px;
        }

        /* Utilitários */
        .d-none { display: none !important; }

        /* --- ESTILOS RESPONSIVOS --- */
        @media (max-width: 768px) {
            .view-container { flex-direction: column; }
            .sidebar, .content-area, #item-registration-view {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                border-right: none;
                z-index: 1;
                background-color: var(--bg-color);
            }
            .content-area, #item-registration-view {
                left: 100%;
                z-index: 2; /* Fica por cima do sidebar */
            }
            .view-container.content-visible .sidebar {
                transform: translateX(-30%); /* Efeito de deslizar para fora */
            }
            .view-container.content-visible .content-area,
            .view-container.content-visible #item-registration-view {
                transform: translateX(-100%);
            }
            
            .content-header-mobile { display: flex; }
            .welcome-message { display: none; } /* Oculta a mensagem de boas vindas em mobile */

            /* Tabela Responsiva para Cards */
            table thead { display: none; }
            table tr {
                display: block;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: var(--white-color);
            }
            table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px dotted var(--border-color);
                text-align: right;
            }
            table td:last-child { border-bottom: none; }
            table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                margin-right: 1rem;
                color: var(--text-color);
            }

            .photo-cell { justify-content: center !important; padding-bottom: 1rem; }
            .photo-cell::before { display: none; } /* Sem label para a foto */
            .quantity-input { text-align: right; }
            
            #wizard-content { width: 95%; max-width: 95%; }
            .items-section-header .btn-group .btn {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            #manual-check-view .modal-content {
                max-width: 95%;
            }
        }
    </style>
</head>
<body>

    <!-- VISÃO PRINCIPAL (CONFERÊNCIA) -->
    <div id="main-view" class="view-container">
        <!-- Painel Lateral Esquerdo -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>📦 Conferência NFe</h1>
                <div class="settings-container">
                    <button id="settings-btn" title="Configurações">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <div id="settings-dropdown" class="dropdown-content d-none">
                        <button class="dropdown-item" onclick="showItemRegistrationView()">Cadastro de Itens</button>
                        <button class="dropdown-item" onclick="showAccountingView()">Contabilidade</button>
                        <button class="dropdown-item" onclick="backupData()">Fazer Backup</button>
                        <button class="dropdown-item" onclick="document.getElementById('restore-file-input').click()">Restaurar</button>
                        <input type="file" id="restore-file-input" class="d-none" accept=".json">
                        <button class="dropdown-item btn-danger" onclick="deleteAllData()">Apagar Tudo</button>
                    </div>
                </div>
            </div>
            <div class="controls-section">
                <button class="btn btn-primary" onclick="document.getElementById('xml-file-input').click()">Importar XML/TXT</button>
                <input type="file" id="xml-file-input" multiple class="d-none" accept=".xml,.nfe,.txt">
                <button class="btn" onclick="displayMultipleXMLs()">Visualizar Seleção</button>
            </div>
            <div class="list-search-controls">
                <input type="text" id="search-xml-input" class="search-input" placeholder="Pesquisar Notas..." onkeyup="filterXMLList('#xml-list', this.value)">
            </div>
            <div class="list-controls d-none" id="main-list-controls">
                <div>
                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked, '#xml-list .xml-checkbox')">
                    <label for="select-all-checkbox">Selecionar Todos</label>
                </div>
                <button id="delete-selected-btn" class="btn btn-danger btn-sm d-none" onclick="deleteSelectedXMLs()">Apagar</button>
            </div>
            <div class="xml-list-container"><ul id="xml-list" class="xml-list"></ul></div>
            <div class="sidebar-footer">
                <strong>Importação Automática:</strong>
                <p id="auto-import-path">A carregar...</p>
            </div>
        </aside>

        <!-- Área de Conteúdo Principal -->
        <main class="content-area">
             <div class="content-header-mobile">
                <button class="btn" onclick="showListView('#main-view')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Voltar
                </button>
            </div>
            <div id="welcome-message" class="welcome-message">
                <div class="icon">📦</div>
                <h2>Selecione uma nota fiscal</h2>
                <p>Escolha um ficheiro na lista à esquerda para ver os seus detalhes.</p>
            </div>
            <div id="xml-content" class="xml-content">
                <div class="nfe-header">
                    <h2 id="nfe-filename"></h2>
                    <p id="nfe-details"></p>
                    <button id="view-all-photos-btn" class="btn d-none">Ver Todas as Fotos</button>
                </div>
                <div class="items-section">
                    <div class="items-section-header">
                        <h3>Itens da Nota</h3>
                        <input type="text" id="filter-input" class="filter-input" placeholder="Filtrar por Descrição/Cód...">
                        <div class="btn-group">
                             <button id="manual-check-trigger-btn" class="btn" disabled>Conferência por EAN</button>
                             <button id="main-action-btn" class="btn"></button>
                             <button id="sort-items-btn" class="btn">Organizar A-Z</button>
                        </div>
                    </div>
                    <div class="items-table-container">
                        <table id="items-table">
                            <thead><tr><th class="photo-cell">Fotos</th><th>Cód.</th><th>Descrição</th><th class="unit-cell">Unid.</th><th>Qtd.</th><th>Recebido</th><th>EAN</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VISÃO DE CONTABILIDADE -->
    <div id="accounting-view" class="view-container d-none">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>📊 Contabilidade</h1>
                 <button class="btn" onclick="showMainView()">Voltar à Conferência</button>
            </div>
            <div class="list-search-controls">
                <input type="text" id="search-accounting-input" class="search-input" placeholder="Pesquisar Notas Arquivadas..." onkeyup="filterXMLList('#accounting-xml-list', this.value)">
            </div>
            <div class="xml-list-container"><ul id="accounting-xml-list" class="xml-list"></ul></div>
        </aside>

        <main class="content-area">
             <div class="content-header-mobile">
                <button class="btn" onclick="showListView('#accounting-view')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Voltar
                </button>
            </div>
            <div id="accounting-welcome-message" class="welcome-message">
                <div class="icon">📊</div>
                <h2>Selecione uma nota arquivada</h2>
                <p>As notas finalizadas aparecem aqui.</p>
            </div>
            <div id="accounting-xml-content" class="xml-content">
                <div class="nfe-header">
                    <h2 id="accounting-nfe-filename"></h2>
                    <p id="accounting-nfe-details"></p>
                    <button id="accounting-view-all-photos-btn" class="btn d-none">Ver Todas as Fotos</button>
                </div>
                <div class="items-section">
                     <div class="items-section-header">
                         <h3>Itens da Nota Arquivada</h3>
                         <div class="btn-group">
                             <button id="wizard-btn" class="btn btn-primary">Wizard</button>
                             <button id="accounting-main-action-btn" class="btn">Reabrir Nota</button>
                             <div class="settings-container">
                                 <button id="accounting-note-settings-btn" title="Opções da Nota" class="btn">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                 </button>
                                 <div id="accounting-note-dropdown" class="dropdown-content d-none" style="min-width: 250px;">
                                     <button id="delete-finished-xml-btn" class="dropdown-item" style="color: var(--danger-color);">Excluir Permanentemente</button>
                                 </div>
                         </div>
                     </div>
                    <div class="items-table-container">
                        <table id="accounting-items-table">
                            <thead><tr><th class="photo-cell">Fotos</th><th>Cód.</th><th>Descrição</th><th class="unit-cell">Unid.</th><th>Qtd.</th><th>Recebido</th><th>EAN</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VISÃO DE CADASTRO DE ITENS -->
    <div id="item-registration-view" class="view-container d-none">
        <main class="content-area">
            <div class="content-header-mobile">
                <button class="btn" onclick="showMainViewFromRegistration()">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Voltar
                </button>
            </div>
            <div class="items-section">
                <h3>Cadastro de Item</h3>
                <div class="form-group">
                    <label for="item-reg-cprod">Código Interno</label>
                    <input type="text" id="item-reg-cprod" class="form-control">
                </div>
                <div class="form-group">
                    <label for="item-reg-ean">EAN</label>
                    <input type="text" id="item-reg-ean" class="form-control">
                </div>
                <div class="form-group">
                    <label for="item-reg-desc">Descrição</label>
                    <input type="text" id="item-reg-desc" class="form-control">
                </div>
                <div class="form-group">
                    <label>Foto do Produto</label>
                    <img id="item-reg-photo-preview" src="" alt="Pré-visualização da foto">
                    <button id="item-reg-add-photo-btn" class="btn">Carregar Foto</button>
                    <input type="file" id="item-reg-photo-input" class="d-none" accept="image/*" capture="environment">
                </div>
                <div class="form-actions">
                    <button class="btn" onclick="fetchItemDataFromXml()">Buscar de XML</button>
                    <button class="btn btn-success" onclick="saveItemRegistration()">Salvar Item</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para galeria de fotos -->
    <div id="photo-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-item-name">Fotos do Item</h3>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="photo-gallery"></div>
            </div>
            <button id="add-photo-btn" class="btn btn-primary" style="margin-top: 15px;">Adicionar/Tirar Foto</button>
            <input type="file" id="photo-input" accept="image/*" multiple class="d-none" capture="environment">
        </div>
    </div>
    
    <!-- Lightbox para visualização de foto expandida -->
    <div id="lightbox">
        <span id="lightbox-close" class="lightbox-nav" onclick="closeLightbox()">&times;</span>
        <span id="lightbox-prev" class="lightbox-nav" onclick="navigateLightbox(-1)">&#10094;</span>
        <img id="lightbox-img" src="">
        <span id="lightbox-next" class="lightbox-nav" onclick="navigateLightbox(1)">&#10095;</span>
        <button id="lightbox-delete" class="lightbox-nav" title="Apagar esta foto" onclick="deleteCurrentLightboxPhoto()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
    </div>

    <!-- Wizard Modal -->
    <div id="wizard-modal" class="modal"> 
        <div id="wizard-content">
            <div id="wizard-header">
                <h3 id="wizard-title">Wizard de Itens</h3>
                <span class="close-button" onclick="closeWizard()">&times;</span>
            </div>
            <div id="wizard-body"></div>
            <div id="wizard-photo-viewer">
                 <button id="wizard-photo-prev" class="wizard-photo-nav">&#10094;</button>
                 <div id="wizard-photo-strip"></div>
                 <button id="wizard-photo-next" class="wizard-photo-nav">&#10095;</button>
            </div>
            <div id="wizard-footer">
                <button id="wizard-prev" class="btn">Anterior</button>
                <span id="wizard-counter">Item 1 de 10</span>
                <button id="wizard-next" class="btn">Próximo</button>
            </div>
        </div>
    </div>

    <!-- Modal de Conferência Manual -->
    <div id="manual-check-view" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Conferência Manual de Item</h3>
                <span class="close-button" onclick="hideManualCheckView()">&times;</span>
            </div>
            <div id="manual-check-form-container" class="modal-body">
                <div class="form-group" style="display: flex; gap: 1rem;">
                    <input type="text" id="manual-check-ean" class="form-control" placeholder="Cole ou digite o EAN do item">
                    <button id="paste-ean-btn" class="btn">Colar</button>
                </div>
                 <div id="manual-check-error" class="d-none"></div>
                 <div id="manual-item-selector-container" class="form-group d-none">
                    <label for="manual-item-selector">O EAN não foi encontrado. A qual item ele pertence?</label>
                    <select id="manual-item-selector" class="form-control"></select>
                    <button id="select-item-btn" class="btn btn-primary" style="margin-top: 0.5rem;">Selecionar Item</button>
                </div>
                <div id="manual-check-details" class="d-none">
                    <div class="form-group">
                        <label for="manual-check-desc">Descrição</label>
                        <input type="text" id="manual-check-desc" class="form-control" disabled>
                    </div>

                    <!-- SEÇÃO DE FOTOS NA CONFERÊNCIA MANUAL -->
                    <div class="form-group" id="manual-check-photo-section">
                        <label>Fotos do Item</label>
                        <div id="manual-check-photo-gallery" class="photo-gallery-inline">
                            <!-- Miniaturas das fotos serão injetadas aqui -->
                        </div>
                        <input type="file" id="manual-check-photo-input" accept="image/*" multiple class="d-none" capture="environment">
                        <button id="manual-check-add-photo-btn" class="btn btn-sm" style="margin-top: 10px;">Adicionar/Tirar Foto</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="manual-check-qty">Quantidade (Nota)</label>
                            <input type="text" id="manual-check-qty" class="form-control" disabled>
                        </div>
                        <div class="form-group">
                            <label for="manual-check-unit-factor">Fator Unitário</label>
                            <input type="number" id="manual-check-unit-factor" class="form-control" value="1">
                        </div>
                        <div class="form-group">
                            <label for="manual-check-received-qty">Quantidade Recebida</label>
                            <input type="number" id="manual-check-received-qty" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="manual-check-unit-type">Caixa ou Unidade</label>
                            <input type="text" id="manual-check-unit-type" class="form-control" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button id="finish-item-btn" class="btn btn-success" disabled>Finalizar Item</button>
            </div>
        </div>
    </div>

    <script>
        // !!! ATENÇÃO: SUBSTITUA 'SEU_IP_LOCAL' PELO ENDEREÇO IP REAL DO SEU COMPUTADOR !!!
        // Exemplo: 'http://192.168.1.100:5000'
        const BASE_URL = 'http://SEU_IP_LOCAL:5000'; // Não esqueça da porta do Flask (geralmente 5000)

        // Conexão Socket.IO para atualizações em tempo real do servidor local
        const socket = io(BASE_URL, { secure: false, transports: ['websocket'] });
        const NFE_NAMESPACE = 'http://www.portalfiscal.inf.br/nfe';
        let currentData = {};
        let currentItemKeyForPhoto = null; 
        let isItemsSorted = false;
        let currentViewMode = 'single';
        let currentAppView = 'main';
        let itemRegPhotoBase64 = null;
        let currentManualCheckCProd = null;
        
        // Lightbox state
        let currentLightboxIndex = -1;
        let lightboxSourceList = [];

        // Wizard state
        let wizardItems = [];
        let wizardCurrentIndex = 0;
        let wizardPhotoIndex = 0;
        let wizardCurrentXmlId = null;

        // Mobile state
        const isMobile = () => window.innerWidth <= 768;
        
        // --- Conexão e Atualizações com o Servidor ---
        socket.on('connect', () => console.log('Ligado ao servidor com sucesso!'));
        socket.on('set_auto_import_path', (data) => document.getElementById('auto-import-path').textContent = data.path);
        
        socket.on('data_updated', () => {
            console.log('Dados atualizados pelo servidor.');
            
            const selectedMainId = (currentAppView === 'main' && currentViewMode === 'single') ? document.querySelector('#xml-list li.selected')?.dataset.id : null;
            const isMultiView = (currentAppView === 'main' && currentViewMode === 'multiple');
            const selectedAccountingId = (currentAppView === 'accounting') ? document.querySelector('#accounting-xml-list li.selected')?.dataset.id : null;
            
            const photoModalIsOpen = document.getElementById('photo-modal').style.display === 'flex';
            const lightboxIsOpen = document.getElementById('lightbox').style.display === 'flex';
            const manualCheckIsOpen = document.getElementById('manual-check-view').style.display === 'flex';

            const oldCProd = currentManualCheckCProd;

            fetchData().then(() => {
                if (manualCheckIsOpen) {
                    renderXMLList();
                    renderAccountingXMLList();
                    if (oldCProd) {
                        renderManualCheckPhotoGallery(oldCProd);
                    }
                    return;
                }

                renderXMLList();
                renderAccountingXMLList();

                if (currentAppView === 'main') {
                    if (isMultiView) {
                        displayMultipleXMLs();
                    } else if (selectedMainId && currentData.xmls.some(xml => xml.id === selectedMainId && !xml.finished)) {
                        displayXMLContent(selectedMainId);
                    } else {
                        resetToWelcomeView();
                    }
                } else if (currentAppView === 'accounting') {
                    if (selectedAccountingId && currentData.xmls.some(xml => xml.id === selectedAccountingId && xml.finished)) {
                        displayFinishedXMLContent(selectedAccountingId);
                    } else {
                       resetToAccountingWelcomeView();
                    }
                }
                
                if (photoModalIsOpen && currentItemKeyForPhoto) {
                    const itemNameElement = document.getElementById('modal-item-name');
                    const itemName = itemNameElement.textContent.replace('Fotos: ', '');
                    
                    openPhotoModal(currentItemKeyForPhoto, itemName, currentAppView === 'accounting');

                    if(lightboxIsOpen) {
                        lightboxSourceList = currentData.item_photos?.[currentItemKeyForPhoto] || [];
                        if (currentLightboxIndex >= lightboxSourceList.length) {
                            closeLightbox();
                        } else {
                            updateLightboxPhoto();
                        }
                    }
                }
            });
        });

        // --- Funções de Navegação e Visão ---
        function showContentView(viewSelector) {
            if (isMobile()) {
                document.querySelector(viewSelector).classList.add('content-visible');
            }
        }

        function showListView(viewSelector) {
            if (isMobile()) {
                document.querySelector(viewSelector).classList.remove('content-visible');
            }
        }
        
        function showMainView() {
            currentAppView = 'main';
            document.getElementById('main-view').classList.remove('d-none');
            document.getElementById('accounting-view').classList.add('d-none');
            document.getElementById('item-registration-view').classList.add('d-none');
            resetToWelcomeView();
        }

        function showMainViewFromRegistration() {
            currentAppView = 'main';
            document.getElementById('main-view').classList.remove('d-none');
            document.getElementById('item-registration-view').classList.add('d-none');
            if (!isMobile()) {
                resetToWelcomeView();
            } else {
                showListView('#main-view');
            }
        }

        function showAccountingView() {
            currentAppView = 'accounting';
            document.getElementById('main-view').classList.add('d-none');
            document.getElementById('accounting-view').classList.remove('d-none');
            document.getElementById('item-registration-view').classList.add('d-none');
            settingsDropdown.classList.add('d-none');
            renderAccountingXMLList();
            resetToAccountingWelcomeView();
        }

        function showItemRegistrationView() {
            currentAppView = 'registration';
            document.getElementById('main-view').classList.add('d-none');
            document.getElementById('accounting-view').classList.add('d-none');
            document.getElementById('item-registration-view').classList.remove('d-none');
            if (isMobile()) {
                 document.querySelector('#item-registration-view').style.transform = 'translateX(-100%)';
            }
            settingsDropdown.classList.add('d-none');
            clearRegistrationForm();
        }

        function resetToWelcomeView() {
            showListView('#main-view');
            document.getElementById('xml-content').style.display = 'none';
            document.getElementById('welcome-message').style.display = 'flex';
            currentViewMode = 'single';
            document.querySelectorAll('#xml-list li.selected').forEach(li => li.classList.remove('selected'));
        }
        
        function resetToAccountingWelcomeView() {
            showListView('#accounting-view');
            document.getElementById('accounting-xml-content').style.display = 'none';
            document.getElementById('accounting-welcome-message').style.display = 'flex';
            document.querySelectorAll('#accounting-xml-list li.selected').forEach(li => li.classList.remove('selected'));
        }

        // --- Funções de Dados ---
        async function fetchData() {
            try {
                const response = await fetch(`${BASE_URL}/api/data`);
                currentData = await response.json();
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                alert('Não foi possível carregar os dados do servidor. Verifique se o servidor Flask está a correr e se o IP está correto.');
            }
        }
        
        function parseXML(xmlStr) {
            const parser = new DOMParser();
            return parser.parseFromString(xmlStr, "application/xml");
        }
        
        // --- Renderização na UI ---
        function renderXMLList() {
            const list = document.getElementById('xml-list');
            const selectedId = document.querySelector('#xml-list li.selected')?.dataset.id;
            const checkedIds = new Set(Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value));
            list.innerHTML = '';
            
            const activeXmls = (currentData.xmls || []).filter(xml => !xml.finished);
            const sortedXmls = activeXmls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedXmls.length === 0) {
                list.innerHTML = '<li style="cursor: default; color: #6c757d; padding: 1rem 1.5rem;">Nenhuma nota para conferir.</li>';
            } else {
                 sortedXmls.forEach(xml => {
                    const li = createXmlListItem(xml, false, checkedIds.has(xml.id));
                    if(xml.id === selectedId) li.classList.add('selected');
                    list.appendChild(li);
                });
            }
            document.getElementById('main-list-controls').style.display = sortedXmls.length > 0 ? 'flex' : 'none';
            filterXMLList('#xml-list', document.getElementById('search-xml-input').value);
            updateSelectionControls();
        }

        function renderAccountingXMLList() {
            const list = document.getElementById('accounting-xml-list');
            const selectedId = document.querySelector('#accounting-xml-list li.selected')?.dataset.id;
            list.innerHTML = '';

            const finishedXmls = (currentData.xmls || []).filter(xml => xml.finished);
            const sortedXmls = finishedXmls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedXmls.length === 0) {
                list.innerHTML = '<li style="cursor: default; color: #6c757d; padding: 1rem 1.5rem;">Nenhuma nota arquivada.</li>';
            } else {
                 sortedXmls.forEach(xml => {
                    const li = createXmlListItem(xml, true);
                     if(xml.id === selectedId) li.classList.add('selected');
                    list.appendChild(li);
                });
            }
        }

        function createXmlListItem(xml, isAccounting, isChecked = false) {
            const li = document.createElement('li');
            li.dataset.id = xml.id;
            
            const xmlDoc = parseXML(xml.xmlContent);
            const nfeNum = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A';
            const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
            const supplierName = emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'Nome não encontrado';
            
            const checkboxHtml = isAccounting ? '' : `<input type="checkbox" class="xml-checkbox" value="${xml.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectionControls()">`;
            const clickHandler = isAccounting ? `displayFinishedXMLContent('${xml.id}')` : `displayXMLContent('${xml.id}')`;

            li.innerHTML = `
                ${checkboxHtml}
                <div class="xml-list-item-content" onclick="${clickHandler}">
                    <strong style="color: var(--primary-color); display: block;">NFe: ${nfeNum}</strong>
                    <span style="font-size: 0.85em; color: var(--secondary-color);">${supplierName}</span>
                </div>
            `;
            li.title = `Ficheiro original: ${xml.fileName}`;
            return li;
        }
        
        function filterXMLList(listSelector, filterText) {
            filterText = filterText.toLowerCase();
            document.querySelectorAll(`${listSelector} li`).forEach(li => {
                if (!li.querySelector('strong')) return;
                const nfeNum = li.querySelector('strong').textContent.toLowerCase();
                const supplierName = li.querySelector('span').textContent.toLowerCase();
                li.style.display = (nfeNum.includes(filterText) || supplierName.includes(filterText)) ? 'flex' : 'none';
            });
        }
        
        function displayXMLContent(xmlId) {
            currentViewMode = 'single';
            document.querySelectorAll('#xml-list li .xml-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('#xml-list li').forEach(li => li.classList.remove('selected'));
            document.querySelector(`#xml-list li[data-id="${xmlId}"]`)?.classList.add('selected');

            const xmlData = currentData.xmls.find(x => x.id === xmlId);
            if (!xmlData || xmlData.finished) {
                resetToWelcomeView();
                return;
            };

            showContentView('#main-view');
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('xml-content').style.display = 'block';
            
            const xmlDoc = parseXML(xmlData.xmlContent);
            setupItemView(xmlId, xmlDoc);
            updateSelectionControls();
        }

        function displayMultipleXMLs() {
            const selectedIds = Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                resetToWelcomeView();
                return;
            }
            
            currentViewMode = 'multiple';
            showContentView('#main-view');
            document.querySelectorAll('#xml-list li').forEach(li => li.classList.remove('selected'));
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('xml-content').style.display = 'block';

            document.getElementById('nfe-filename').textContent = `${selectedIds.length} Notas Fiscais Selecionadas`;
            document.getElementById('nfe-details').innerHTML = 'Visualização combinada de múltiplos ficheiros.';
            document.getElementById('view-all-photos-btn').classList.add('d-none');
            
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.textContent = "Finalizar Seleção";
            actionBtn.className = 'btn btn-success';
            actionBtn.onclick = finishSelectedXMLs;
            actionBtn.classList.remove('d-none');
            
            document.getElementById('sort-items-btn').disabled = false;
            document.getElementById('manual-check-trigger-btn').disabled = false;

            const sortBtn = document.getElementById('sort-items-btn');
            sortBtn.onclick = () => {
                isItemsSorted = !isItemsSorted;
                sortBtn.textContent = isItemsSorted ? 'Ordem Original' : 'Organizar A-Z';
                displayMultipleXMLs(); // Re-render sorted table
            };

            const tbody = document.querySelector('#items-table tbody');
            tbody.innerHTML = '';
            
            let allItems = [];
            selectedIds.forEach(xmlId => {
                const xmlData = currentData.xmls.find(x => x.id === xmlId);
                if (!xmlData) return;
                const xmlDoc = parseXML(xmlData.xmlContent);
                const items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
                items.forEach(item => allItems.push({xmlId, itemNode: item}));
            });

            if (isItemsSorted) {
                allItems.sort((a, b) => {
                    const nameA = a.itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
                    const nameB = b.itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
                    return nameA.localeCompare(nameB);
                });
            }

            allItems.forEach(itemData => {
                 appendItemsToTable(itemData.xmlId, [itemData.itemNode], '#items-table tbody', false);
            });
        }


        function displayFinishedXMLContent(xmlId) {
            document.querySelectorAll('#accounting-xml-list li').forEach(li => li.classList.toggle('selected', li.dataset.id === xmlId));
            const xmlData = currentData.xmls.find(x => x.id === xmlId);
            if (!xmlData || !xmlData.finished) {
                resetToAccountingWelcomeView();
                return;
            };
            showContentView('#accounting-view');
            document.getElementById('accounting-welcome-message').style.display = 'none';
            document.getElementById('accounting-xml-content').style.display = 'block';

            const xmlDoc = parseXML(xmlData.xmlContent);
            
            const ide = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'ide')[0];
            const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
            document.getElementById('accounting-nfe-filename').textContent = `Nota Fiscal: ${ide?.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A'}`;
            document.getElementById('accounting-nfe-details').innerHTML = `<strong>Emitente:</strong> ${emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'N/A'}`;
            
            const allPhotosBtn = document.getElementById('accounting-view-all-photos-btn');
            const allNFePhotos = getAllPhotosForNFe(xmlId);
            if (allNFePhotos.length > 0) {
                allPhotosBtn.classList.remove('d-none');
                allPhotosBtn.onclick = () => openAllPhotosModal(allNFePhotos, xmlData.fileName);
            } else {
                allPhotosBtn.classList.add('d-none');
            }

            document.getElementById('accounting-main-action-btn').onclick = () => unfinishXML(xmlId);
            document.getElementById('wizard-btn').onclick = () => openWizard(xmlId);
            document.getElementById('delete-finished-xml-btn').onclick = () => deleteFinishedXML(xmlId);

            renderItemsTable(xmlId, xmlDoc, '#accounting-items-table tbody', true);
        }

        function setupItemView(xmlId, xmlDoc) {
            isItemsSorted = false;
            document.getElementById('filter-input').value = '';
            document.getElementById('filter-input').onkeyup = () => filterTable('#items-table', document.getElementById('filter-input').value);
            
            const actionBtn = document.getElementById('main-action-btn');
            actionBtn.classList.remove('d-none');
            actionBtn.textContent = 'Finalizar';
            actionBtn.className = 'btn btn-success';
            actionBtn.onclick = () => finishXML(xmlId);
            
            document.getElementById('sort-items-btn').disabled = false;
            document.getElementById('manual-check-trigger-btn').disabled = false;


            const ide = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'ide')[0];
            const emit = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'emit')[0];
            document.getElementById('nfe-filename').textContent = `Nota Fiscal: ${ide?.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A'}`;
            document.getElementById('nfe-details').innerHTML = `<strong>Emitente:</strong> ${emit?.getElementsByTagNameNS(NFE_NAMESPACE, 'xNome')[0]?.textContent || 'N/A'}`;
            
            const allPhotosBtn = document.getElementById('view-all-photos-btn');
            const allNFePhotos = getAllPhotosForNFe(xmlId);
            if (allNFePhotos.length > 0) {
                allPhotosBtn.classList.remove('d-none');
                allPhotosBtn.onclick = () => openAllPhotosModal(allNFePhotos, currentData.xmls.find(x => x.id === xmlId).fileName);
            } else {
                allPhotosBtn.classList.add('d-none');
            }
            
            const sortBtn = document.getElementById('sort-items-btn');
            sortBtn.textContent = 'Organizar A-Z';
            sortBtn.onclick = () => {
                isItemsSorted = !isItemsSorted;
                sortBtn.textContent = isItemsSorted ? 'Ordem Original' : 'Organizar A-Z';
                renderItemsTable(xmlId, xmlDoc, '#items-table tbody', false);
            };

            renderItemsTable(xmlId, xmlDoc, '#items-table tbody', false);
        }

        function renderItemsTable(xmlId, xmlDoc, tableBodySelector, isReadOnly) {
            const tbody = document.querySelector(tableBodySelector);
            tbody.innerHTML = '';
            let items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
            if (isItemsSorted && !isReadOnly) {
                items.sort((a, b) => {
                    const nameA = a.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
                    const nameB = b.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
                    return nameA.localeCompare(nameB);
                });
            }
            appendItemsToTable(xmlId, items, tableBodySelector, isReadOnly);
            if (!isReadOnly) filterTable('#items-table', document.getElementById('filter-input').value);
        }

        function appendItemsToTable(xmlId, items, tableBodySelector, isReadOnly) {
            const tbody = document.querySelector(tableBodySelector);
            for (const item of items) {
                const prod = item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
                const cProd = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent;
                
                if (!cProd) {
                    console.warn("Item sem cProd encontrado e ignorado:", prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent);
                    continue;
                }
                
                const prodName = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
                
                const photos = currentData.item_photos?.[cProd] || [];
                let photoCellHtml = '';
                const clickHandler = `openPhotoModal('${cProd}', '${prodName.replace(/'/g, "\\'")}', ${isReadOnly})`;
                
                if (isReadOnly) {
                     photoCellHtml = photos.length > 0 ? `<div class="thumbnail-container" onclick="${clickHandler}"><img src="${photos[0]}" class="thumbnail-img"></div>` : 'Sem Fotos';
                } else {
                    if (photos.length === 0) {
                        photoCellHtml = `<button class="btn btn-sm" onclick="${clickHandler}">Adicionar</button>`;
                    } else {
                        let thumbnailsHtml = `<img src="${photos[0]}" class="thumbnail-img">`;
                        if (photos.length > 1) thumbnailsHtml += `<span class="thumbnail-counter">+${photos.length - 1}</span>`;
                        photoCellHtml = `<div class="thumbnail-container" onclick="${clickHandler}">${thumbnailsHtml}</div>`;
                    }
                }

                const row = tbody.insertRow();
                row.dataset.cprod = cProd;
                
                row.innerHTML = `
                    <td data-label="Fotos" class="photo-cell">${photoCellHtml}</td>
                    <td data-label="Cód.">${cProd}</td>
                    <td data-label="Descrição">${prodName}</td>
                    <td data-label="Unid." class="unit-cell">${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'uCom')[0]?.textContent || ''}</td>
                    <td data-label="Qtd.">${parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'qCom')[0]?.textContent || 0).toFixed(2)}</td>
                    <td data-label="Recebido"><input type="number" class="quantity-input" data-cprod="${cProd}" onchange="saveReceivedQty(this.dataset.cprod, this.value)" value="${currentData.received_qtys?.[cProd] || ''}" ${isReadOnly ? 'disabled' : ''}></td>
                    <td data-label="EAN">${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || ''}</td>
                `;
            }
        }
        
        function filterTable(tableSelector, filterText) {
            filterText = filterText.toLowerCase();
            document.querySelectorAll(`${tableSelector} tbody tr`).forEach(row => {
                const descCell = isMobile() ? row.querySelector('td[data-label="Descrição"]') : row.cells[2];
                const codeCell = isMobile() ? row.querySelector('td[data-label="Cód."]') : row.cells[1];
                
                const desc = descCell?.textContent.toLowerCase() || '';
                const code = codeCell?.textContent.toLowerCase() || '';

                row.style.display = (code.includes(filterText) || desc.includes(filterText)) ? '' : 'none';
            });
        }
        
        function getAllPhotosForNFe(xmlId) {
            const xmlData = currentData.xmls.find(x => x.id === xmlId);
            if (!xmlData) return [];
            
            const xmlDoc = parseXML(xmlData.xmlContent);
            const items = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
            const cProdSet = new Set(items.map(item => item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0]?.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent).filter(Boolean));

            let allPhotos = [];
            cProdSet.forEach(cProd => {
                if (currentData.item_photos?.[cProd]) {
                    allPhotos = allPhotos.concat(currentData.item_photos[cProd]);
                }
            });
            return allPhotos;
        }

        // --- Ações (upload, backup, delete, etc.) ---
        document.getElementById('xml-file-input').addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const formData = new FormData();
            for (const file of e.target.files) formData.append('xml_files', file);
            try {
                const response = await fetch(`${BASE_URL}/api/upload_xml`, { method: 'POST', body: formData });
                const result = await response.json();
                alert(result.message);
                if (response.ok) fetchData();
            } catch (error) { alert('Erro ao enviar ficheiro(s). Verifique a conexão com o servidor.'); }
            e.target.value = '';
        });
        
        function backupData() {
            fetch(`${BASE_URL}/api/data`).then(res => res.json()).then(fullData => {
                const dataStr = JSON.stringify(fullData, null, 4);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_nfe_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
        
        document.getElementById('restore-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('backup_file', file);
            if (confirm('Tem a certeza que deseja restaurar? Todos os dados atuais serão substituídos.')) {
                try {
                    const response = await fetch(`${BASE_URL}/api/restore`, { method: 'POST', body: formData });
                    const result = await response.json();
                    alert(result.message);
                    if(response.ok) fetchData();
                } catch (error) { alert('Erro ao restaurar a cópia de segurança. Verifique a conexão com o servidor.'); }
            }
            e.target.value = '';
        });
        
        async function deleteAllData() {
            if (confirm('ATENÇÃO! Esta ação é irreversível. Deseja mesmo apagar todos os dados?')) {
                try {
                    const response = await fetch(`${BASE_URL}/api/delete_all_data`, { method: 'DELETE' });
                    alert((await response.json()).message);
                    fetchData();
                    resetToWelcomeView();
                } catch (error) { alert('Erro ao apagar os dados. Verifique a conexão com o servidor.'); }
            }
        }
        
        async function deleteSelectedXMLs() {
            const selectedIds = Array.from(document.querySelectorAll('#main-list-controls .xml-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0 || !confirm(`Tem a certeza que deseja apagar os ${selectedIds.length} item(ns) selecionado(s)?`)) return;
             try {
                const response = await fetch(`${BASE_URL}/api/xmls/delete`, { 
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids: selectedIds })
                 });
                if(response.ok) resetToWelcomeView();
                alert((await response.json()).message);
             } catch (error) { alert('Erro ao apagar os itens selecionados. Verifique a conexão com o servidor.'); }
        }

        async function deleteFinishedXML(xmlId) {
            if (!xmlId) return;
            if (confirm('Tem a certeza que deseja excluir PERMANENTEMENTE esta nota fiscal e todos os seus dados associados? Esta ação não pode ser desfeita.')) {
                try {
                    const response = await fetch(`${BASE_URL}/api/xml/delete/${xmlId}`, { method: 'DELETE' });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) {
                        resetToAccountingWelcomeView();
                    }
                } catch (error) {
                    console.error("Erro ao excluir a nota fiscal:", error);
                    alert('Erro de comunicação ao excluir a nota fiscal. Verifique a conexão com o servidor.');
                }
            }
        }

        async function saveReceivedQty(cProd, quantity) {
            try {
                const response = await fetch(`${BASE_URL}/api/save_received_qty`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cProd, quantity: parseFloat(quantity) })
                });

                if (!response.ok) {
                    console.error('O servidor respondeu com um erro:', response.status);
                    const errorData = await response.text();
                    console.error('Detalhes do erro:', errorData);
                    alert(`Ocorreu um erro no servidor ao guardar a quantidade. Status: ${response.status}. Verifique a conexão.`);
                }
            } catch (error) {
                console.error('Erro de rede ao guardar a quantidade:', error);
                alert('Erro de comunicação ao guardar a quantidade recebida. Verifique a conexão com o servidor.');
            }
        }
        
        async function finishXML(xmlId) {
            if (confirm('Tem a certeza que deseja finalizar esta nota? Ela será movida para a Contabilidade.')) {
                try {
                    const response = await fetch(`${BASE_URL}/api/xmls/finish`, { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ ids: [xmlId] })
                    });
                    if(response.ok) {
                        resetToWelcomeView();
                    }
                    alert((await response.json()).message);
                } catch (error) { alert('Erro de comunicação ao finalizar a nota. Verifique a conexão com o servidor.'); }
            }
        }

        async function finishSelectedXMLs() {
            const selectedIds = Array.from(document.querySelectorAll('#xml-list .xml-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                alert("Nenhuma nota selecionada para finalizar.");
                return;
            }

            if (confirm(`Tem a certeza que deseja finalizar as ${selectedIds.length} notas selecionadas? Elas serão movidas para a Contabilidade.`)) {
                try {
                    const response = await fetch(`${BASE_URL}/api/xmls/finish`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: selectedIds })
                    });
                    if (response.ok) {
                        resetToWelcomeView();
                    }
                    alert((await response.json()).message);
                } catch (error) { alert('Erro de comunicação ao finalizar as notas. Verifique a conexão com o servidor.'); }
            }
        }
        
        async function unfinishXML(xmlId) {
             if (confirm('Tem a certeza que deseja reabrir esta nota? Ela voltará para a tela de conferência.')) {
                try {
                    const response = await fetch(`${BASE_URL}/api/xml/unfinish/${xmlId}`, { method: 'POST' });
                    if(response.ok) {
                        showMainView();
                    }
                    alert((await response.json()).message);
                } catch (error) { alert('Erro de comunicação ao reabrir a nota. Verifique a conexão com o servidor.'); }
            }
        }

        function updateSelectionControls() {
            const allCheckboxes = document.querySelectorAll('#main-list-controls .xml-checkbox');
            const checkedCheckboxes = document.querySelectorAll('#main-list-controls .xml-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');

            if (checkedCheckboxes.length > 0) {
                deleteSelectedBtn.classList.remove('d-none');
            } else {
                deleteSelectedBtn.classList.add('d-none');
            }
            if (!selectAllCheckbox) return;
            selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
        }

        function toggleSelectAll(checked, selector) {
             document.querySelectorAll(selector).forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateSelectionControls();
        }

        // --- Funções de Fotos e Modais ---
        function openPhotoModal(cProd, itemName, isReadOnly) {
            currentItemKeyForPhoto = cProd;
            lightboxSourceList = currentData.item_photos?.[cProd] || [];
            document.getElementById('modal-item-name').textContent = `Fotos: ${itemName}`;
            
            const addPhotoBtn = document.getElementById('add-photo-btn');
            const photoInput = document.getElementById('photo-input');
            addPhotoBtn.style.display = isReadOnly ? 'none' : 'block';
            // O clique no botão agora simplesmente abre o input de arquivo, que gerencia a câmera/galeria
            addPhotoBtn.onclick = () => photoInput.click();

            const gallery = document.getElementById('photo-gallery');
            gallery.innerHTML = '';
            lightboxSourceList.forEach((photoBase64, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item';
                const deleteBtnHtml = isReadOnly ? '' : `<button class="delete-photo-btn" title="Apagar foto" onclick="deletePhoto(event, '${cProd}', ${index})">&times;</button>`;
                itemDiv.innerHTML = `<img src="${photoBase64}" onclick="openLightbox(event, ${index}, '${cProd}', ${isReadOnly})">${deleteBtnHtml}`;
                gallery.appendChild(itemDiv);
            });
            document.getElementById('photo-modal').style.display = 'flex';
        }
        
        async function deletePhoto(event, cProd, index) {
            event.stopPropagation();
            if (!cProd || !confirm('Tem a certeza que deseja apagar esta foto?')) return;
            
            try {
                const response = await fetch(`${BASE_URL}/api/delete_photo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cProd, photoIndex: index })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Resposta inválida do servidor.' }));
                    alert(`Erro ao apagar a foto: ${errorData.message}. Verifique a conexão com o servidor.`);
                } else {
                     if (document.getElementById('lightbox').style.display === 'flex') {
                        closeLightbox();
                     }
                }
            } catch (error) { 
                console.error("Erro de comunicação ao apagar foto:", error);
                alert('Erro de comunicação ao apagar a foto. Verifique a conexão com o servidor.'); 
            }
        }

        function openAllPhotosModal(allPhotos, nfeName) {
            currentItemKeyForPhoto = null;
            lightboxSourceList = allPhotos;
            document.getElementById('modal-item-name').textContent = `Todas as Fotos: ${nfeName}`;
            document.getElementById('add-photo-btn').style.display = 'none';
            
            const gallery = document.getElementById('photo-gallery');
            gallery.innerHTML = '';
            allPhotos.forEach((photoBase64, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item';
                itemDiv.innerHTML = `<img src="${photoBase64}" onclick="openLightbox(event, ${index}, null, true)">`; 
                gallery.appendChild(itemDiv);
            });
            document.getElementById('photo-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('photo-modal').style.display = 'none';
            currentItemKeyForPhoto = null;
        }

        function openLightbox(event, index, cProd, isReadOnly) {
            event.stopPropagation(); // Evita o clique no item da galeria subjacente
            currentItemKeyForPhoto = cProd; 
            if (cProd) {
                lightboxSourceList = currentData.item_photos?.[cProd] || [];
            }
            
            currentLightboxIndex = index;
            document.getElementById('lightbox').style.display = 'flex';
            document.getElementById('lightbox-delete').style.display = (isReadOnly || !cProd) ? 'none' : 'block';
            updateLightboxPhoto();
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            currentLightboxIndex = -1;
        }
        function navigateLightbox(direction) {
            if (lightboxSourceList.length === 0) return;
            currentLightboxIndex = (currentLightboxIndex + direction + lightboxSourceList.length) % lightboxSourceList.length;
            updateLightboxPhoto();
        }
        function updateLightboxPhoto() {
            if(currentLightboxIndex > -1 && currentLightboxIndex < lightboxSourceList.length) {
                document.getElementById('lightbox-img').src = lightboxSourceList[currentLightboxIndex];
            } else {
                closeLightbox();
            }
        }
        function deleteCurrentLightboxPhoto() {
            if(currentLightboxIndex > -1 && currentItemKeyForPhoto) {
                deletePhoto(new Event('delete'), currentItemKeyForPhoto, currentLightboxIndex);
            }
        }

        // --- WIZARD ---
        function openWizard(xmlId) {
            wizardCurrentXmlId = xmlId;
            const xmlData = currentData.xmls.find(x => x.id === xmlId);
            if (!xmlData) return;
            const xmlDoc = parseXML(xmlData.xmlContent);
            wizardItems = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det'));
            wizardCurrentIndex = 0;
            document.getElementById('wizard-modal').style.display = 'flex';
            document.getElementById('wizard-prev').onclick = () => navigateWizard(-1);
            document.getElementById('wizard-next').onclick = () => navigateWizard(1);
            document.getElementById('wizard-photo-prev').onclick = () => navigateWizardPhotos(-1);
            document.getElementById('wizard-photo-next').onclick = () => navigateWizardPhotos(1);
            renderWizardItem();
        }

        function closeWizard() {
            document.getElementById('wizard-modal').style.display = 'none';
            wizardItems = [];
        }
        
        function navigateWizard(direction) {
            wizardCurrentIndex += direction;
            renderWizardItem();
        }

        function renderWizardItem() {
            wizardPhotoIndex = 0;
            if (wizardCurrentIndex < 0 || wizardCurrentIndex >= wizardItems.length) {
                closeWizard(); 
                return;
            };
            const item = wizardItems[wizardCurrentIndex];
            
            const prod = item.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
            const vUnCom = parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'vUnCom')[0]?.textContent || 0);
            const qCom = parseFloat(prod.getElementsByTagNameNS(NFE_NAMESPACE, 'qCom')[0]?.textContent || 0);
            const cProd = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent || '';

            const body = document.getElementById('wizard-body');
            body.innerHTML = `
                <div class="wizard-item-info"><strong>Código:</strong> <span>${cProd}</span></div>
                <div class="wizard-item-info"><strong>Descrição:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || ''}</span></div>
                <div class="wizard-item-info"><strong>EAN:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || 'N/A'}</span></div>
                <div class="wizard-item-info"><strong>Unidade:</strong> <span>${prod.getElementsByTagNameNS(NFE_NAMESPACE, 'uCom')[0]?.textContent || ''}</span></div>
                <div class="wizard-item-info"><strong>Quantidade:</strong> <span>${qCom.toFixed(2)}</span></div>
                <div class="wizard-item-info"><strong>Preço Unitário:</strong> <span>R$ ${vUnCom.toFixed(2)}</span></div>
                <div class="wizard-item-info"><strong>Preço Total:</strong> <span>R$ ${(vUnCom * qCom).toFixed(2)}</span></div>
            `;

            document.getElementById('wizard-counter').textContent = `Item ${wizardCurrentIndex + 1} de ${wizardItems.length}`;
            document.getElementById('wizard-prev').disabled = wizardCurrentIndex === 0;
            document.getElementById('wizard-next').disabled = wizardCurrentIndex === wizardItems.length - 1;
            renderWizardPhotos(cProd);
        }

        function renderWizardPhotos(cProd) {
            if (!cProd) return;
            const photos = currentData.item_photos?.[cProd] || [];
            
            const photoViewer = document.getElementById('wizard-photo-viewer');
            const photoStrip = document.getElementById('wizard-photo-strip');
            const prevBtn = document.getElementById('wizard-photo-prev');
            const nextBtn = document.getElementById('wizard-photo-next');
            
            photoStrip.innerHTML = '';

            if (photos.length === 0) {
                photoViewer.style.display = 'none';
                return;
            }
            
            photoViewer.style.display = 'flex';

            const photosToShow = photos.slice(wizardPhotoIndex, wizardPhotoIndex + 2);
            
            photosToShow.forEach((photoSrc, localIndex) => {
                const img = document.createElement('img');
                img.src = photoSrc;
                const globalPhotoIndex = wizardPhotoIndex + localIndex;
                img.onclick = (event) => {
                    lightboxSourceList = photos;
                    openLightbox(event, globalPhotoIndex, cProd, true); 
                };
                photoStrip.appendChild(img);
            });

            prevBtn.disabled = wizardPhotoIndex <= 0;
            nextBtn.disabled = wizardPhotoIndex >= photos.length - 2;
            
            if (photos.length <= 2) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }

        function navigateWizardPhotos(direction) {
            wizardPhotoIndex += direction;
            renderWizardPhotos(wizardItems[wizardCurrentIndex].getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0]?.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent);
        }
        
        // --- START: Funções de Conferência Manual ---
        
        function clearManualCheckForm(isNewEan = true) {
            currentManualCheckCProd = null;
            document.getElementById('manual-check-details').classList.add('d-none');
            document.getElementById('manual-item-selector-container').classList.add('d-none');
            document.getElementById('manual-check-error').classList.add('d-none');
            document.getElementById('finish-item-btn').disabled = true;

            if (isNewEan) {
                document.getElementById('manual-check-ean').value = '';
                document.getElementById('manual-check-ean').focus();
            }

            document.getElementById('manual-check-desc').value = '';
            document.getElementById('manual-check-qty').value = '';
            document.getElementById('manual-check-unit-factor').value = '1';
            document.getElementById('manual-check-received-qty').value = '';
            document.getElementById('manual-check-unit-type').value = '';
            document.getElementById('manual-check-photo-gallery').innerHTML = '';
        }
        
        function openManualCheckView() {
            document.getElementById('manual-check-view').style.display = 'flex';
            clearManualCheckForm();
        }
        
        function hideManualCheckView() {
             document.getElementById('manual-check-view').style.display = 'none';
        }
        
        async function pasteEan() {
            try {
                const text = await navigator.clipboard.readText();
                const eanInput = document.getElementById('manual-check-ean');
                eanInput.value = text;
                eanInput.dispatchEvent(new Event('input', { bubbles: true })); // Dispara o evento para procurar o item
            } catch (err) {
                console.error('Falha ao colar texto: ', err);
                alert('Não foi possível ler da área de transferência. Verifique as permissões do seu navegador.');
            }
        }
        
        function findItemByEan(ean) {
            if (!ean) {
                clearManualCheckForm(false);
                return;
            }
            const rows = document.querySelectorAll('#items-table tbody tr');
            let foundRow = null;

            for (const row of rows) {
                const eanCell = isMobile() ? row.querySelector('td[data-label="EAN"]') : row.cells[6];
                if (eanCell && eanCell.textContent.trim() === ean) {
                    foundRow = row;
                    break;
                }
            }
            
            const errorDiv = document.getElementById('manual-check-error');
            const selectorContainer = document.getElementById('manual-item-selector-container');
            
            if (foundRow) {
                errorDiv.classList.add('d-none');
                selectorContainer.classList.add('d-none');
                populateManualCheckForm(foundRow);
            } else {
                errorDiv.textContent = 'EAN não encontrado. Associe-o a um item da lista:';
                errorDiv.classList.remove('d-none');
                
                document.getElementById('manual-check-details').classList.add('d-none');
                document.getElementById('finish-item-btn').disabled = true;

                const selector = document.getElementById('manual-item-selector');
                selector.innerHTML = '<option value="">Selecione um item...</option>'; 

                rows.forEach(row => {
                    const cProd = row.dataset.cprod;
                    if (!cProd) return;
                    const desc = (isMobile() ? row.querySelector('td[data-label="Descrição"]').textContent : row.cells[2].textContent).trim();
                    const option = document.createElement('option');
                    option.value = cProd;
                    option.textContent = `${cProd} - ${desc}`;
                    selector.appendChild(option);
                });

                selectorContainer.classList.remove('d-none');
            }
        }

        function handleManualItemSelection() {
            const selector = document.getElementById('manual-item-selector');
            const selectedCProd = selector.value;
            if (!selectedCProd) return;

            const foundRow = document.querySelector(`#items-table tbody tr[data-cprod="${selectedCProd}"]`);
            if (foundRow) {
                document.getElementById('manual-check-error').classList.add('d-none');
                document.getElementById('manual-item-selector-container').classList.add('d-none');
                populateManualCheckForm(foundRow);
            }
        }
        
        function populateManualCheckForm(row) {
            const cProd = row.dataset.cprod;
            if (!cProd) return;
            currentManualCheckCProd = cProd;

            const desc = (isMobile() ? row.querySelector('td[data-label="Descrição"]').textContent : row.cells[2].textContent).trim();
            const unit = (isMobile() ? row.querySelector('td[data-label="Unid."]').textContent : row.cells[3].textContent).trim();
            const qty = (isMobile() ? row.querySelector('td[data-label="Qtd."]').textContent : row.cells[4].textContent).trim();
            const receivedQtyInput = row.querySelector('.quantity-input');
            
            document.getElementById('manual-check-details').classList.remove('d-none');
            document.getElementById('manual-check-desc').value = desc;
            document.getElementById('manual-check-qty').value = qty;
            document.getElementById('manual-check-unit-type').value = unit;
            document.getElementById('manual-check-received-qty').value = receivedQtyInput.value;
            
            renderManualCheckPhotoGallery(cProd);

            document.getElementById('finish-item-btn').disabled = false;
            document.getElementById('manual-check-received-qty').focus();
        }

        function renderManualCheckPhotoGallery(cProd) {
            const gallery = document.getElementById('manual-check-photo-gallery');
            gallery.innerHTML = '';
            if (!cProd) return;

            const photos = currentData.item_photos?.[cProd] || [];
            photos.forEach((photoBase64, index) => {
                 const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item';
                const deleteBtnHtml = `<button class="delete-photo-btn" title="Apagar foto" onclick="deleteManualCheckPhoto(event, '${cProd}', ${index})">&times;</button>`;
                itemDiv.innerHTML = `<img src="${photoBase64}">${deleteBtnHtml}`;
                gallery.appendChild(itemDiv);
            });
        }

        async function deleteManualCheckPhoto(event, cProd, index) {
            event.stopPropagation();
            if (!cProd || !confirm('Tem a certeza que deseja apagar esta foto?')) return;
            
            if(currentData.item_photos?.[cProd]) {
                currentData.item_photos[cProd].splice(index, 1);
                renderManualCheckPhotoGallery(cProd); 
            }

            try {
                const response = await fetch(`${BASE_URL}/api/delete_photo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cProd, photoIndex: index })
                });
                if (!response.ok) {
                    alert(`Erro ao apagar a foto. Verifique a conexão com o servidor.`);
                    fetchData(); 
                }
            } catch (error) { 
                alert('Erro de comunicação ao apagar a foto. Verifique a conexão com o servidor.'); 
                fetchData(); 
            }
        }
        
        async function finishManualCheckItem() {
            if (!currentManualCheckCProd) return;
            
            const receivedQty = document.getElementById('manual-check-received-qty').value;
            const factor = parseFloat(document.getElementById('manual-check-unit-factor').value) || 1;
            const finalQty = parseFloat(receivedQty) * factor;

            const mainTableInput = document.querySelector(`#items-table .quantity-input[data-cprod="${currentManualCheckCProd}"]`);
            if (mainTableInput) {
                mainTableInput.value = finalQty;
                mainTableInput.closest('tr').classList.add('item-highlight');
                setTimeout(() => {
                    mainTableInput.closest('tr').classList.remove('item-highlight');
                }, 2500);
            }

            await saveReceivedQty(currentManualCheckCProd, finalQty);
            clearManualCheckForm();
        }

        // --- END: Funções de Conferência Manual ---
        
        async function handlePhotoUpload(event, cProd, successCallback) {
            if (!cProd || !event.target.files || event.target.files.length === 0) return;
            
            const btn = document.getElementById('add-photo-btn');
            const manualBtn = document.getElementById('manual-check-add-photo-btn');
            if (btn) { btn.textContent = 'A enviar...'; btn.disabled = true; }
            if (manualBtn) { manualBtn.textContent = 'A enviar...'; manualBtn.disabled = true; }

            const formData = new FormData();
            formData.append('cProd', cProd);
            
            for (const file of event.target.files) {
                const newFileName = `${cProd}_${Date.now()}.${file.name.split('.').pop()}`;
                formData.append('photos', file, newFileName);
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/save_photo`, { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) {
                    alert(`Erro ao guardar as fotos: ${result.message}. Verifique a conexão com o servidor.`);
                } else {
                    if (!currentData.item_photos) currentData.item_photos = {};
                    currentData.item_photos[cProd] = result.photos;
                    if(successCallback) successCallback(cProd);
                }
            } catch (error) { 
                console.error("Erro de comunicação ao adicionar foto:", error);
                alert('Erro de comunicação ao guardar as fotos. Verifique a conexão com o servidor.'); 
            } finally {
                event.target.value = '';
                if (btn) { btn.textContent = 'Adicionar/Tirar Foto'; btn.disabled = false; }
                if (manualBtn) { manualBtn.textContent = 'Adicionar/Tirar Foto'; manualBtn.disabled = false; }
            }
        }


        // --- Funções de Cadastro de Item ---
        function clearRegistrationForm() {
            document.getElementById('item-reg-cprod').value = '';
            document.getElementById('item-reg-ean').value = '';
            document.getElementById('item-reg-desc').value = '';
            const preview = document.getElementById('item-reg-photo-preview');
            preview.src = '';
            preview.style.display = 'none';
            itemRegPhotoBase64 = null;
        }

        async function saveItemRegistration() {
            const cprod = document.getElementById('item-reg-cprod').value.trim();
            const ean = document.getElementById('item-reg-ean').value.trim();
            const desc = document.getElementById('item-reg-desc').value.trim();

            if (!cprod || !desc) {
                alert("Código Interno e Descrição são campos obrigatórios.");
                return;
            }

            const itemData = { cprod, ean, desc, photo: itemRegPhotoBase64 };

            try {
                const response = await fetch(`${BASE_URL}/api/register_item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    clearRegistrationForm();
                    showMainView();
                }
            } catch (error) {
                console.error("Erro ao salvar item:", error);
                alert("Erro de comunicação ao salvar o item. Verifique a conexão com o servidor.");
            }
        }
        
        function fetchItemDataFromXml() {
            const nfeNumber = prompt("Digite o número da NFe para buscar o item:");
            if (!nfeNumber) return;
            const itemNumber = prompt(`Digite o número do item (nItem) da NFe ${nfeNumber}:`);
            if (!itemNumber) return;

            const xmlData = currentData.xmls.find(xml => {
                const xmlDoc = parseXML(xml.xmlContent);
                const nfeNum = xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'nNF')[0]?.textContent || 'N/A';
                return nfeNum === nfeNumber;
            });

            if (!xmlData) {
                alert(`NFe com número ${nfeNumber} não encontrada.`);
                return;
            }
            
            const xmlDoc = parseXML(xmlData.xmlContent);
            const itemNode = Array.from(xmlDoc.getElementsByTagNameNS(NFE_NAMESPACE, 'det')).find(det => det.getAttribute('nItem') === itemNumber);

            if (!itemNode) {
                alert(`Item ${itemNumber} não encontrado na NFe ${nfeNumber}.`);
                return;
            }
            
            const prod = itemNode.getElementsByTagNameNS(NFE_NAMESPACE, 'prod')[0];
            document.getElementById('item-reg-cprod').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cProd')[0]?.textContent || '';
            document.getElementById('item-reg-ean').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'cEAN')[0]?.textContent || '';
            document.getElementById('item-reg-desc').value = prod.getElementsByTagNameNS(NFE_NAMESPACE, 'xProd')[0]?.textContent || '';
        }


        // --- Lógica do Dropdown e Carregamento Inicial ---
        window.onload = () => {
            const settingsBtn = document.getElementById('settings-btn');
            const settingsDropdown = document.getElementById('settings-dropdown');
            const accNoteSettingsBtn = document.getElementById('accounting-note-settings-btn');
            const accNoteDropdown = document.getElementById('accounting-note-dropdown');

            accNoteSettingsBtn.onclick = function(event) {
                event.stopPropagation();
                accNoteDropdown.classList.toggle('d-none');
            };

            settingsBtn.onclick = (e) => { e.stopPropagation(); settingsDropdown.classList.toggle('d-none'); }
            
            window.onclick = (e) => {
                if (!settingsDropdown.classList.contains('d-none') && !settingsBtn.contains(e.target)) {
                    settingsDropdown.classList.add('d-none');
                }
                if (!accNoteDropdown.classList.contains('d-none') && !accNoteSettingsBtn.contains(e.target)) {
                    accNoteDropdown.classList.add('d-none');
                }
            }

            fetchData().then(() => {
                renderXMLList();
                renderAccountingXMLList();
            });

            // Event listeners principais
            document.getElementById('manual-check-trigger-btn').addEventListener('click', openManualCheckView);
            document.getElementById('paste-ean-btn').addEventListener('click', pasteEan);
            document.getElementById('manual-check-ean').addEventListener('input', (e) => findItemByEan(e.target.value));
            document.getElementById('select-item-btn').addEventListener('click', handleManualItemSelection);
            document.getElementById('finish-item-btn').addEventListener('click', finishManualCheckItem);

            // Event listeners para o upload de fotos (usando input type="file" com capture="environment")
            document.getElementById('manual-check-add-photo-btn').addEventListener('click', () => document.getElementById('manual-check-photo-input').click());
            document.getElementById('manual-check-photo-input').addEventListener('change', (e) => handlePhotoUpload(e, currentManualCheckCProd, renderManualCheckPhotoGallery));
            
            document.getElementById('item-reg-add-photo-btn').addEventListener('click', () => document.getElementById('item-reg-photo-input').click());
            document.getElementById('item-reg-photo-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        itemRegPhotoBase64 = event.target.result;
                        document.getElementById('item-reg-photo-preview').src = itemRegPhotoBase64;
                        document.getElementById('item-reg-photo-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('add-photo-btn').addEventListener('click', () => document.getElementById('photo-input').click());
            document.getElementById('photo-input').addEventListener('change', (e) => handlePhotoUpload(e, currentItemKeyForPhoto, (cProd) => {
                // Após o upload, atualiza a galeria de fotos do modal
                const itemNameElement = document.getElementById('modal-item-name');
                const itemName = itemNameElement.textContent.replace('Fotos: ', '');
                openPhotoModal(cProd, itemName, currentAppView === 'accounting');
            }));
        };
    </script>
</body>
</html>
